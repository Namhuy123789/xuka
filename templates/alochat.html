<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XUKA 4.0 - Alo Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    html, body {
      margin: 0; padding: 0; height: 100vh; overflow: hidden;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
    }
    .chat-bubble { padding: 4px 8px; border-radius: 6px; }
    .activity-label { font-size: 0.75rem; color: green; display: none; }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center p-4">

  <!-- Đăng nhập -->
  <div id="loginPanel" class="w-full max-w-sm bg-white p-5 rounded-xl shadow-md mt-10">
    <h2 class="text-xl font-semibold text-center text-gray-700 mb-5">🔐 Nhập tên & mã phòng</h2>
    <input id="usernameInput" class="w-full p-2 border rounded mb-3" placeholder="Tên người dùng" />
    <input id="roomInput" class="w-full p-2 border rounded mb-4" placeholder="Mã phòng (vd: abc123)" />
    <button onclick="login()" class="w-full py-2 bg-blue-600 text-white rounded">Đăng nhập</button>
  </div>

  <!-- Giao diện chính -->
  <div id="mainPanel" class="hidden w-full max-w-4xl bg-white p-4 rounded-xl shadow-md space-y-4">
    <div class="text-center space-y-1">
      <h2 id="userLabel" class="font-semibold text-gray-800">👤 Bạn</h2>
      <div id="statusLabel" class="text-green-600">🟢 ALO CHAT</div>
      <div id="activityLabel" class="activity-label">🎙️ Đang nói…</div>
    </div>

    <!-- Camera -->
    <div class="flex gap-4 justify-center">
      <div class="text-center">
        <h3 class="text-xs">Camera của bạn</h3>
        <video id="localVideo" autoplay muted class="w-48 rounded border-2 border-blue-500"></video>
      </div>
      <div class="text-center">
        <h3 class="text-xs">Camera người kia</h3>
        <video id="remoteVideo" autoplay class="w-48 rounded border-2 border-red-500"></video>
      </div>
    </div>

    <!-- Nút điều khiển -->
    <div class="flex gap-2 justify-center">
      <button onclick="toggleCamera()" id="camBtn" class="px-3 py-1 bg-green-500 text-white rounded">
        <i class="fas fa-video"></i> Bật Camera
      </button>
      <button onclick="toggleMic()" id="micBtn" class="px-3 py-1 bg-green-500 text-white rounded">
        <i class="fas fa-microphone"></i> Bật Mic
      </button>
    </div>

    <!-- Chat -->
    <div id="chatBox" class="p-2 border rounded h-40 overflow-y-auto text-sm"></div>

    <!-- Gửi tin nhắn -->
    <div class="flex gap-2">
      <input id="messageInput" class="flex-1 border p-2 rounded" placeholder="Nhập tin nhắn..." />
      <button onclick="sendMessage()" class="bg-blue-500 text-white px-3 rounded"><i class="fas fa-paper-plane"></i> Gửi</button>
    </div>

    <!-- Gửi file -->
    <div class="flex gap-2">
      <input id="fileInput" type="file" class="flex-1 border p-2 rounded text-xs" />
      <button onclick="sendFile()" class="bg-purple-500 text-white px-3 rounded"><i class="fas fa-paperclip"></i> Gửi file</button>
    </div>
  </div>

<script>
const socket = io({ path: '/socket.io', transports: ['websocket', 'polling'] });

let username = '', room = '';
let localStream, audioTrack, videoTrack, peerConnection;
const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

function login() {
  username = document.getElementById("usernameInput").value.trim();
  room = document.getElementById("roomInput").value.trim();
  if (!username || !room) return alert("Nhập đủ tên & mã phòng!");

  document.getElementById("loginPanel").classList.add("hidden");
  document.getElementById("mainPanel").classList.remove("hidden");
  document.getElementById("userLabel").textContent = `👤 ${username}`;

  socket.emit("join_room", { name: username, room: room });
}

socket.on("peer_online", data => {
  if (data.name !== username) {
    document.getElementById("statusLabel").textContent = `🟢 ${data.name} đang online`;
    startConnection();
  }
});

function toggleCamera() {
  if (!videoTrack) { startMedia(true, false); }
  else {
    videoTrack.enabled = !videoTrack.enabled;
    document.getElementById("camBtn").innerHTML = `<i class="fas fa-video"></i> ${videoTrack.enabled ? "Tắt Camera" : "Bật Camera"}`;
  }
}

function toggleMic() {
  if (!audioTrack) { startMedia(false, true); }
  else {
    audioTrack.enabled = !audioTrack.enabled;
    document.getElementById("micBtn").innerHTML = `<i class="fas fa-microphone"></i> ${audioTrack.enabled ? "Tắt Mic" : "Bật Mic"}`;
  }
}

function startMedia(useVideo = true, useAudio = true) {
  navigator.mediaDevices.getUserMedia({ video: useVideo, audio: useAudio })
    .then(stream => {
      if (!localStream) {
        localStream = stream;
        document.getElementById("localVideo").srcObject = stream;
      }
      if (useVideo) videoTrack = stream.getVideoTracks()[0];
      if (useAudio) {
        audioTrack = stream.getAudioTracks()[0];
        detectSpeaking(stream);
      }
      if (peerConnection) stream.getTracks().forEach(t => peerConnection.addTrack(t, stream));
    })
    .catch(e => alert("Không thể truy cập media: " + e));
}

function detectSpeaking(stream) {
  const ctx = new AudioContext();
  const source = ctx.createMediaStreamSource(stream);
  const analyser = ctx.createAnalyser();
  const data = new Uint8Array(analyser.frequencyBinCount);
  source.connect(analyser);
  function checkVolume() {
    analyser.getByteFrequencyData(data);
    const volume = data.reduce((a, b) => a + b, 0) / data.length;
    document.getElementById("activityLabel").style.display = volume > 10 ? "block" : "none";
    requestAnimationFrame(checkVolume);
  }
  checkVolume();
}

function startConnection() {
  peerConnection = new RTCPeerConnection(config);
  if (localStream) localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
  peerConnection.ontrack = e => document.getElementById("remoteVideo").srcObject = e.streams[0];
  peerConnection.onicecandidate = e => { if (e.candidate) socket.emit("ice_candidate", { room, candidate: e.candidate }); };

  peerConnection.createOffer().then(offer => peerConnection.setLocalDescription(offer))
    .then(() => socket.emit("offer", { room, offer: peerConnection.localDescription }));
}

socket.on("offer", data => {
  if (!peerConnection) startConnection();
  peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer))
    .then(() => peerConnection.createAnswer())
    .then(answer => peerConnection.setLocalDescription(answer))
    .then(() => socket.emit("answer", { room, answer: peerConnection.localDescription }));
});

socket.on("answer", data => {
  peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
});

socket.on("ice_candidate", data => {
  peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
});

function sendMessage() {
  const msg = document.getElementById("messageInput").value.trim();
  if (!msg) return;
  socket.emit("send_message", { room, from: username, text: msg });
  document.getElementById("messageInput").value = '';
}

socket.on("receive_message", data => {
  const chat = document.getElementById("chatBox");
  chat.innerHTML += `<p><strong>${data.from}:</strong> ${data.text}</p>`;
  chat.scrollTop = chat.scrollHeight;
});

function sendFile() {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return alert("Chọn file!");
  const reader = new FileReader();
  reader.onload = () => {
    socket.emit("send_file", { room, from: username, name: file.name, type: file.type, data: reader.result });
  };
  reader.readAsDataURL(file);
}

socket.on("receive_file", data => {
  const chat = document.getElementById("chatBox");
  let html = `<p><strong>${data.from}:</strong><br/>`;
  if (data.type.startsWith("image/")) html += `<img src="${data.data}" class="max-h-32 mt-1 rounded"/>`;
  else if (data.type.startsWith("video/")) html += `<video controls src="${data.data}" class="max-h-48 mt-1 rounded"></video>`;
  else html += `<a href="${data.data}" download="${data.name}" class="text-blue-500 underline">📎 ${data.name}</a>`;
  chat.innerHTML += html + `</p>`;
  chat.scrollTop = chat.scrollHeight;
});
</script>

</body>
</html>
