<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XUKA 4.0 - Alo Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
      transition: background-color 0.3s, color 0.3s;
    }
    .dark {
      background: linear-gradient(to bottom, #1f2937, #374151);
      color: #e5e7eb;
    }
    .dark .bg-white { background-color: #374151; }
    .dark .text-gray-700 { color: #e5e7eb; }
    .dark .bg-gray-50 { background-color: #4b5563; }
    .chat-bubble {
      margin-bottom: 0.5rem;
      padding: 0.4rem 0.75rem;
      line-height: 1.4rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      background-color: #e5e7eb;
      color: #1f2937;
      word-break: break-word;
    }
    .chat-bubble.self {
      background-color: #2563eb !important;
      color: white !important;
      margin-left: auto;
      max-width: 70%;
    }
    .chat-bubble.other {
      background-color: #ffffff !important;
      color: #1f2937 !important;
      margin-right: auto;
      max-width: 70%;
    }
    .dark .chat-bubble.self {
      background-color: #3b82f6 !important;
      color: white !important;
    }
    .dark .chat-bubble.other {
      background-color: #4b5563 !important;
      color: #e5e7eb !important;
    }
    .scroll-to-bottom {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background-color: #2563eb;
      color: white;
      border-radius: 50%;
      padding: 0.4rem;
      cursor: pointer;
      display: none;
      font-size: 0.875rem;
    }
    .btn-icon {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      transition: all 0.2s ease;
    }
    .video-container {
      max-width: 100%;
      aspect-ratio: 16 / 9;
    }
    #chatBox > div {
      background: transparent !important;
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
      border-radius: 0 !important;
      line-height: 1.3;
    }
    .error-message {
      color: #dc2626;
      text-align: center;
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-start p-3 sm:p-4">
  <!-- Dark mode toggle -->
  <button id="themeToggle" class="fixed top-3 right-3 p-1.5 bg-gray-800 text-white rounded-full hover:bg-gray-700 transition text-sm">
    <i class="fas fa-moon"></i>
  </button>

  <!-- ƒêƒÉng nh·∫≠p -->
  <div id="loginPanel" class="w-full max-w-sm bg-white p-5 rounded-xl shadow-md mt-10">
    <h2 class="text-xl font-semibold text-center text-gray-700 mb-5">üîê Nh·∫≠p t√™n v√† m√£ ph√≤ng</h2>
    <input id="usernameInput" class="w-full p-2.5 border rounded-md mb-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="T√™n ng∆∞·ªùi d√πng" />
    <input id="roomInput" class="w-full p-2.5 border rounded-md mb-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="M√£ ph√≤ng (vd: abc123)" />
    <button onclick="login()" class="w-full py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm">ƒêƒÉng nh·∫≠p</button>
    <p id="loginError" class="error-message hidden"></p>
  </div>

  <!-- Giao di·ªán ch√≠nh -->
  <div id="mainPanel" class="hidden w-full max-w-4xl bg-white p-4 rounded-xl shadow-md mt-0 space-y-4">
    <div class="text-center space-y-1">
      <h2 id="userLabel" class="text-lg font-semibold text-gray-800">üë§ B·∫°n</h2>
      <div id="statusLabel" class="text-base font-medium text-green-600">üü¢ ALO CHAT</div>
      <div id="typingIndicator" class="text-xs text-gray-500 hidden">ƒêang nh·∫≠p...</div>
      <p id="errorMessage" class="error-message hidden"></p>
    </div>

    <!-- Camera -->
    <div class="flex flex-col sm:flex-row justify-center gap-4">
      <div class="text-center space-y-1 video-container">
        <h3 class="text-gray-600 text-xs">Camera c·ªßa b·∫°n</h3>
        <video id="localVideo" autoplay muted class="w-full h-32 rounded-lg shadow-sm object-cover border-2 border-blue-500"></video>
      </div>
      <div class="text-center space-y-1 video-container">
        <h3 class="text-gray-600 text-xs">Camera ng∆∞·ªùi kia</h3>
        <video id="remoteVideo" autoplay class="w-full h-32 rounded-lg shadow-sm object-cover border-2 border-red-500"></video>
      </div>
    </div>

    <center class="text-xs text-gray-500">B·∫£n quy·ªÅn ¬© 2025 <span class="font-semibold text-red-600">PH·∫†M HUY TU√ÇN</span> ¬∑ ƒêT: <a href="tel:0389897989" class="text-blue-600 hover:underline">0389 897 989</a></center>

    <!-- N√∫t ƒëi·ªÅu khi·ªÉn -->
    <div class="flex justify-center gap-1 flex-wrap text-xs items-center">
      <button onclick="toggleCamera()" id="camBtn" class="h-8 px-2 bg-green-500 text-white hover:bg-green-600 rounded flex items-center gap-1">
        <i class="fas fa-video"></i> B·∫≠t Camera
      </button>
      <button onclick="toggleMic()" id="micBtn" class="h-8 px-2 bg-green-500 text-white hover:bg-green-600 rounded flex items-center gap-1">
        <i class="fas fa-microphone"></i> B·∫≠t Mic
      </button>
      <button onclick="toggleSpeechTranslation()" id="speechTranslateBtn" class="h-8 px-2 bg-yellow-500 text-white hover:bg-yellow-600 rounded flex items-center gap-1">
        <i class="fas fa-language"></i> Phi√™n d·ªãch n√≥i
      </button>
      <select id="translateLang" class="h-8 px-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
        <option value="en">Ti·∫øng Anh</option>
        <option value="vi">Ti·∫øng Vi·ªát</option>
        <option value="zh-CN">Ti·∫øng Trung</option>
        <option value="fr">Ti·∫øng Ph√°p</option>
      </select>
      <button onclick="toggleTranslation()" id="translateBtn" class="h-8 px-2 bg-blue-500 text-white hover:bg-blue-600 rounded flex items-center gap-1">
        <i class="fas fa-globe"></i> Phi√™n d·ªãch chat
      </button>
    </div>

    <!-- Chat -->
    <div class="relative">
      <div id="chatBox" class="mt-2 p-3 bg-transparent h-40 overflow-y-auto text-sm border rounded-md relative"></div>
      <button id="scrollToBottom" class="scroll-to-bottom"><i class="fas fa-arrow-down"></i></button>
    </div>

    <!-- G·ª≠i tin nh·∫Øn -->
    <div class="flex gap-2 mt-2">
      <input id="messageInput" class="flex-1 border p-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Nh·∫≠p tin nh·∫Øn..." />
      <button onclick="sendMessage()" class="btn-icon bg-blue-500 text-white hover:bg-blue-600"><i class="fas fa-paper-plane"></i> G·ª≠i</button>
    </div>

    <!-- G·ª≠i file -->
    <div class="flex gap-2 items-center mt-2">
      <input id="fileInput" type="file" accept="image/*,video/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" class="flex-1 border p-2 rounded-md text-xs focus:outline-none focus:ring-2 focus:ring-purple-400" />
      <small class="text-xs text-gray-500 hidden sm:block">Nh·∫•n Enter ƒë·ªÉ g·ª≠i file</small>
      <button onclick="sendFile()" class="btn-icon bg-purple-500 text-white hover:bg-purple-600"><i class="fas fa-paperclip"></i> G·ª≠i file</button>
    </div>

    <!-- File preview -->
    <div id="filePreview" class="hidden mt-2">
      <div id="previewContent" class="text-center"></div>
    </div>

    <!-- Ti·∫øn tr√¨nh g·ª≠i -->
    <div id="progressContainer" class="w-full mt-2 hidden">
      <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
        <div id="progressBar" class="bg-green-500 h-2 transition-all duration-200" style="width: 0%"></div>
      </div>
      <div id="progressEstimate" class="text-xs text-gray-600 mt-1 text-center"></div>
    </div>
  </div>

<script>
const API_BASE = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1")
  ? "http://127.0.0.1:5000"
  : "https://xuka.com.vn";

const te = new TextEncoder();
const td = new TextDecoder();

const socket = io(API_BASE, {
  path: '/socket.io',
  transports: ['websocket', 'polling'],
  reconnectionAttempts: 5,
  reconnectionDelay: 1000
});

let username = '';
let room = '';
let localStream;
let audioTrack, videoTrack;
let peerConnection;
const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

function showError(elementId, message) {
  const errorElement = document.getElementById(elementId);
  errorElement.textContent = message;
  errorElement.classList.remove('hidden');
  setTimeout(() => errorElement.classList.add('hidden'), 5000);
}

socket.on('connect', () => {
  console.log('‚úÖ ƒê√£ k·∫øt n·ªëi t·ªõi server:', socket.id);
  document.getElementById('statusLabel').textContent = 'üü¢ ALO CHAT';
});

socket.on('connect_error', (error) => {
  console.error('K·∫øt n·ªëi th·∫•t b·∫°i:', error);
  showError('errorMessage', `Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server: ${error.message}`);
});

socket.on('disconnect', () => {
  console.log('M·∫•t k·∫øt n·ªëi t·ªõi server');
  showError('errorMessage', 'M·∫•t k·∫øt n·ªëi t·ªõi server!');
  document.getElementById('statusLabel').textContent = 'üî¥ M·∫•t k·∫øt n·ªëi';
});

function login() {
  username = document.getElementById('usernameInput').value.trim();
  room = document.getElementById('roomInput').value.trim();
  if (!username || !room) {
    showError('loginError', 'Vui l√≤ng nh·∫≠p t√™n v√† m√£ ph√≤ng!');
    return;
  }

  document.getElementById('loginPanel').classList.add('hidden');
  document.getElementById('mainPanel').classList.remove('hidden');
  document.getElementById('userLabel').textContent = `üë§ ${username}`;
  socket.emit('user_online', { name: username, room });
}

socket.on('peer_online', data => {
  const other = data.name !== username ? data.name : null;
  if (other) {
    document.getElementById('statusLabel').textContent = `üü¢ ${other} ƒëang online`;
    startConnection();
  }
});

function toggleCamera() {
  if (!videoTrack) {
    startMedia(true, false);
  } else {
    videoTrack.enabled = !videoTrack.enabled;
    document.getElementById('camBtn').innerHTML = videoTrack.enabled ? '<i class="fas fa-video"></i> T·∫Øt Camera' : '<i class="fas fa-video-slash"></i> B·∫≠t Camera';
  }
}

function toggleMic() {
  if (!audioTrack) {
    startMedia(false, true);
  } else {
    audioTrack.enabled = !audioTrack.enabled;
    document.getElementById('micBtn').innerHTML = audioTrack.enabled ? '<i class="fas fa-microphone"></i> T·∫Øt Mic' : '<i class="fas fa-microphone-slash"></i> B·∫≠t Mic';
  }
}

function startMedia(useVideo = true, useAudio = true) {
  navigator.mediaDevices.getUserMedia({ video: useVideo, audio: useAudio })
    .then(stream => {
      localStream = stream;
      document.getElementById('localVideo').srcObject = stream;

      if (useVideo) {
        videoTrack = stream.getVideoTracks()[0];
        document.getElementById('camBtn').innerHTML = '<i class="fas fa-video"></i> T·∫Øt Camera';
      }

      if (useAudio) {
        audioTrack = stream.getAudioTracks()[0];
        document.getElementById('micBtn').innerHTML = '<i class="fas fa-microphone"></i> T·∫Øt Mic';
        detectSpeaking(stream);
      }

      if (peerConnection) {
        stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
      }
    })
    .catch(e => showError('errorMessage', 'Kh√¥ng th·ªÉ truy c·∫≠p media: ' + e.message));
}

function detectSpeaking(stream) {
  const ctx = new AudioContext();
  const source = ctx.createMediaStreamSource(stream);
  const analyser = ctx.createAnalyser();
  const data = new Uint8Array(analyser.frequencyBinCount);
  source.connect(analyser);

  function checkVolume() {
    analyser.getByteFrequencyData(data);
    const volume = data.reduce((a, b) => a + b, 0) / data.length;
    document.getElementById('typingIndicator').classList.toggle('hidden', volume < 10);
    requestAnimationFrame(checkVolume);
  }

  checkVolume();
}

function startConnection() {
  peerConnection = new RTCPeerConnection(config);

  if (localStream) {
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
  }

  peerConnection.ontrack = event => {
    document.getElementById('remoteVideo').srcObject = event.streams[0];
  };

  peerConnection.onicecandidate = event => {
    if (event.candidate) {
      socket.emit('ice_candidate', { candidate: event.candidate, room });
    }
  };

  peerConnection.createOffer().then(offer => {
    return peerConnection.setLocalDescription(offer);
  }).then(() => {
    socket.emit('offer', { offer: peerConnection.localDescription, room });
  }).catch(e => showError('errorMessage', 'L·ªói WebRTC: ' + e.message));
}

socket.on('offer', data => {
  if (!peerConnection) startConnection();

  peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer)).then(() => {
    return peerConnection.createAnswer();
  }).then(answer => {
    return peerConnection.setLocalDescription(answer);
  }).then(() => {
    socket.emit('answer', { answer: peerConnection.localDescription, room });
  }).catch(e => showError('errorMessage', 'L·ªói x·ª≠ l√Ω offer: ' + e.message));
});

socket.on('answer', data => {
  peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer))
    .catch(e => showError('errorMessage', 'L·ªói x·ª≠ l√Ω answer: ' + e.message));
});

socket.on('ice_candidate', data => {
  peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate))
    .catch(e => showError('errorMessage', 'L·ªói ICE candidate: ' + e.message));
});

function sendMessage() {
  const msg = document.getElementById('messageInput').value.trim();
  if (!username) {
    showError('errorMessage', 'Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi g·ª≠i tin nh·∫Øn!');
    return;
  }
  if (!msg) return;

  const encodedMsg = td.decode(te.encode(msg)); // M√£ h√≥a UTF-8
  const chat = document.getElementById('chatBox');
  chat.innerHTML += `<div class="chat-bubble self"><strong>${username}:</strong> ${encodedMsg}</div>`;
  chat.scrollTop = chat.scrollHeight;

  socket.emit('send_message', { from: username, text: encodedMsg, room });
  document.getElementById('messageInput').value = '';
}

socket.on('receive_message', data => {
  const chat = document.getElementById('chatBox');
  const decodedMsg = td.decode(te.encode(data.text)); // Gi·∫£i m√£ UTF-8
  chat.innerHTML += `<div class="chat-bubble other"><strong>${data.from}:</strong> ${decodedMsg}</div>`;
  chat.scrollTop = chat.scrollHeight;
});

function sendFile() {
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files[0];
  if (!file) {
    showError('errorMessage', 'Ch·ªçn m·ªôt file ƒë·ªÉ g·ª≠i!');
    return;
  }
  if (file.size > 10 * 1024 * 1024) {
    showError('errorMessage', 'File qu√° l·ªõn! Vui l√≤ng ch·ªçn file d∆∞·ªõi 10MB.');
    return;
  }

  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');
  const progressEstimate = document.getElementById('progressEstimate');
  progressContainer.classList.remove('hidden');

  const reader = new FileReader();
  reader.onprogress = (event) => {
    if (event.lengthComputable) {
      const percent = (event.loaded / event.total) * 100;
      progressBar.style.width = `${percent}%`;
      progressEstimate.textContent = `ƒêang t·∫£i: ${Math.round(percent)}%`;
    }
  };
  reader.onload = () => {
    const fileData = reader.result; // DataURL
    socket.emit('send_file', {
      from: username,
      name: file.name,
      type: file.type,
      data: fileData,
      room
    });
    progressContainer.classList.add('hidden');
    fileInput.value = '';
    // Hi·ªÉn th·ªã file ƒë√£ g·ª≠i ·ªü client g·ª≠i
    const chat = document.getElementById('chatBox');
    let html = `<div class="chat-bubble self"><strong>${username}:</strong><br/>`;
    if (file.type.startsWith('image/')) {
      html += `<img src="${fileData}" alt="${file.name}" class="max-h-32 mt-1 rounded-md"/>`;
    } else if (file.type.startsWith('video/')) {
      html += `<video controls src="${fileData}" class="max-h-48 mt-1 rounded-md"></video>`;
    } else if (file.type === 'application/pdf' ||
               file.type === 'application/msword' ||
               file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ||
               file.type === 'application/vnd.ms-excel' ||
               file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
      html += `<a href="${fileData}" download="${file.name}" class="text-blue-500 underline">üìé ${file.name}</a>`;
    } else {
      html += `<span class="text-red-500">File kh√¥ng h·ªó tr·ª£: ${file.name}</span>`;
    }
    html += `</div>`;
    chat.innerHTML += html;
    chat.scrollTop = chat.scrollHeight;
  };
  reader.onerror = () => showError('errorMessage', 'L·ªói ƒë·ªçc file!');
  reader.readAsDataURL(file); // C√≥ th·ªÉ ƒë·ªïi sang readAsArrayBuffer n·∫øu server h·ªó tr·ª£
}

socket.on('receive_file', data => {
  const chat = document.getElementById('chatBox');
  const { from, name, type, data: fileData } = data;
  let html = `<div class="chat-bubble other"><strong>${from}:</strong><br/>`;
  if (type.startsWith('image/')) {
    html += `<img src="${fileData}" alt="${name}" class="max-h-32 mt-1 rounded-md"/>`;
  } else if (type.startsWith('video/')) {
    html += `<video controls src="${fileData}" class="max-h-48 mt-1 rounded-md"></video>`;
  } else if (type === 'application/pdf' ||
             type === 'application/msword' ||
             type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ||
             type === 'application/vnd.ms-excel' ||
             type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
    html += `<a href="${fileData}" download="${name}" class="text-blue-500 underline">üìé ${name}</a>`;
  } else {
    html += `<span class="text-red-500">File kh√¥ng h·ªó tr·ª£: ${name}</span>`;
  }
  html += `</div>`;
  chat.innerHTML += html;
  chat.scrollTop = chat.scrollHeight;
});

// X·ª≠ l√Ω dark mode toggle
document.getElementById('themeToggle').addEventListener('click', () => {
  document.body.classList.toggle('dark');
  const icon = document.getElementById('themeToggle').querySelector('i');
  icon.classList.toggle('fa-moon');
  icon.classList.toggle('fa-sun');
});

// H√†m gi·∫£ l·∫≠p cho phi√™n d·ªãch (tri·ªÉn khai th√™m n·∫øu c·∫ßn)
function toggleTranslation() {
  showError('errorMessage', 'Ch·ª©c nƒÉng phi√™n d·ªãch chat ch∆∞a ƒë∆∞·ª£c tri·ªÉn khai!');
}

function toggleSpeechTranslation() {
  showError('errorMessage', 'Ch·ª©c nƒÉng phi√™n d·ªãch n√≥i ch∆∞a ƒë∆∞·ª£c tri·ªÉn khai!');
}
</script>
</body>
</html>
