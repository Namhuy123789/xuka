<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XUKA 4.0 - Alo Chat (Sửa)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    html, body { margin: 0; padding: 0; height: 100vh; font-family: 'Inter', system-ui, -apple-system, sans-serif; background: linear-gradient(to bottom, #f1f5f9, #e2e8f0); }
    .dark { background: linear-gradient(to bottom, #1f2937, #374151); color: #e5e7eb; }
    .chat-bubble { margin-bottom: .5rem; padding: .4rem .75rem; border-radius: .5rem; font-size: .875rem; word-break: break-word; }
    .scroll-to-bottom { position: absolute; bottom: 8px; right: 8px; background-color: #2563eb; color: white; border-radius: 999px; padding: .4rem; cursor: pointer; display: none; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-3 sm:p-4">
  <!-- Dark mode toggle -->
  <button id="themeToggle" class="fixed top-3 right-3 p-1.5 bg-gray-800 text-white rounded-full hover:bg-gray-700 transition text-sm">
    <i class="fas fa-moon"></i>
  </button>

  <!-- Đăng nhập -->
  <div id="loginPanel" class="w-full max-w-sm bg-white p-5 rounded-xl shadow-md mt-10">
    <h2 class="text-xl font-semibold text-center text-gray-700 mb-5">🔐 Nhập tên và mã phòng</h2>
    <input id="usernameInput" class="w-full p-2.5 border rounded-md mb-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Tên người dùng" />
    <input id="roomInput" class="w-full p-2.5 border rounded-md mb-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Mã phòng (vd: abc123)" />
    <button onclick="login()" class="w-full py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm">Đăng nhập</button>
  </div>

  <!-- Giao diện chính -->
  <div id="mainPanel" class="hidden w-full max-w-4xl bg-white p-4 rounded-xl shadow-md mt-0 space-y-4">
    <div class="text-center space-y-1">
      <h2 id="userLabel" class="text-lg font-semibold text-gray-800">👤 Bạn</h2>
      <div id="statusLabel" class="text-base font-medium text-green-600">⚪ Chưa kết nối</div>
      <div id="typingIndicator" class="text-xs text-gray-500 hidden">Đang nhập...</div>
      <span id="activityLabel" class="hidden text-xs text-green-500">🟢 Đang nói…</span>
    </div>

    <!-- Camera -->
    <div class="flex flex-col sm:flex-row justify-center gap-4">
      <div class="text-center space-y-1 video-container w-full sm:w-1/2">
        <h3 class="text-gray-600 text-xs">Camera của bạn</h3>
        <video id="localVideo" autoplay muted class="w-full h-40 rounded-lg shadow-sm object-cover border-2 border-blue-500 bg-black"></video>
      </div>
      <div class="text-center space-y-1 video-container w-full sm:w-1/2">
        <h3 class="text-gray-600 text-xs">Camera người kia</h3>
        <video id="remoteVideo" autoplay class="w-full h-40 rounded-lg shadow-sm object-cover border-2 border-red-500 bg-black"></video>
      </div>
    </div>

    <center class="text-xs text-gray-500">Bản quyền © 2025 <span class="font-semibold text-red-600">PHẠM HUY TUÂN</span> · ĐT: <a href="tel:0389897989" class="text-blue-600 hover:underline">0389 897 989</a></center>

    <!-- Nút điều khiển -->
    <div class="flex justify-center gap-1 flex-wrap text-xs items-center">
      <button onclick="toggleCamera()" id="camBtn" class="h-8 px-2 bg-green-500 text-white hover:bg-green-600 rounded flex items-center gap-1">
        <i class="fas fa-video"></i> Bật Camera
      </button>
      <button onclick="toggleMic()" id="micBtn" class="h-8 px-2 bg-green-500 text-white hover:bg-green-600 rounded flex items-center gap-1">
        <i class="fas fa-microphone"></i> Bật Mic
      </button>
      <button onclick="toggleTranslation()" id="translateBtn" class="h-8 px-2 bg-blue-500 text-white hover:bg-blue-600 rounded flex items-center gap-1">
        <i class="fas fa-globe"></i> Phiên dịch chat
      </button>
      <select id="translateLang" class="h-8 px-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
        <option value="en">Tiếng Anh</option>
        <option value="vi">Tiếng Việt</option>
        <option value="zh-CN">Tiếng Trung</option>
        <option value="fr">Tiếng Pháp</option>
      </select>
    </div>

    <!-- Chat -->
    <div class="relative">
      <div id="chatBox" class="mt-2 p-3 bg-transparent h-40 overflow-y-auto text-sm border rounded-md relative"></div>
      <button id="scrollToBottom" class="scroll-to-bottom"><i class="fas fa-arrow-down"></i></button>
    </div>

    <!-- Gửi tin nhắn -->
    <div class="flex gap-2 mt-2">
      <input id="messageInput" class="flex-1 border p-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Nhập tin nhắn..." />
      <button onclick="sendMessage()" class="btn-icon bg-blue-500 text-white hover:bg-blue-600 px-3 py-2 rounded"><i class="fas fa-paper-plane"></i> Gửi</button>
    </div>

    <!-- Gửi file -->
    <div class="flex gap-2 items-center mt-2">
      <input id="fileInput" type="file" accept="image/*,video/*,application/pdf" class="flex-1 border p-2 rounded-md text-xs focus:outline-none focus:ring-2 focus:ring-purple-400" />
      <button onclick="sendFile()" class="btn-icon bg-purple-500 text-white hover:bg-purple-600 px-3 py-2 rounded"><i class="fas fa-paperclip"></i> Gửi file</button>
    </div>

    <!-- File preview + progress -->
    <div id="filePreview" class="hidden mt-2">
      <div id="previewContent" class="text-center"></div>
    </div>

    <div id="progressContainer" class="w-full mt-2 hidden">
      <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
        <div id="progressBar" class="bg-green-500 h-2 transition-all duration-200" style="width: 0%"></div>
      </div>
      <div id="progressEstimate" class="text-xs text-gray-600 mt-1 text-center"></div>
    </div>
  </div>

<script>
/* ======= Config & state ======= */
const socket = io({ path: '/socket.io', transports: ['websocket','polling'] });
let username = '';
let room = '';
let localStream = null;
let audioTrack = null, videoTrack = null;
let peerConnection = null;
let isInitiator = false;
let currentPeerName = null; // tên đối tác
const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

/* ======= Utility ======= */
function log(...args){ console.log(...args); }
function escapeHtml(s){ return String(s||'').replace(/[&<>\"'\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;","/":"&#x2F;"})[c]); }
function showStatus(t){ document.getElementById('statusLabel').textContent = t; }

/* ======= Socket events ======= */
socket.on('connect', () => { log('socket connect', socket.id); showStatus('🔌 Socket connected'); });
socket.on('connect_error', (err) => { console.error('connect_error', err); showStatus('❗ Lỗi kết nối'); });
socket.on('disconnect', (r) => { console.warn('disconnect', r); showStatus('⚪ Đã ngắt'); });

// Peer online in same room
socket.on('peer_online', data => {
  if (!username) return;
  const other = data.name !== username ? data.name : null;
  if (!other) return;
  currentPeerName = other;
  document.getElementById('statusLabel').textContent = `🟢 ${other} đang online`;
  // simple deterministic initiator rule to avoid both creating offers
  isInitiator = username < other;
  if (isInitiator) startConnection(true); else startConnection(false);
});

socket.on('offer', async data => {
  if (!peerConnection) startConnection(false);
  await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
  const answer = await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);
  socket.emit('answer', { to: data.from, answer: peerConnection.localDescription });
});

socket.on('answer', async data => {
  if (peerConnection && data.answer) {
    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
  }
});

socket.on('ice_candidate', async data => {
  try{
    if (peerConnection && data.candidate) await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
  }catch(e){ console.warn('addIce err', e); }
});

socket.on('receive_message', data => {
  const chat = document.getElementById('chatBox');
  const p = document.createElement('div');
  p.className = 'chat-bubble';
  p.innerHTML = `<strong>${escapeHtml(data.from)}:</strong> ${escapeHtml(data.text)}`;
  chat.appendChild(p);
  chat.scrollTop = chat.scrollHeight;
});

/* ======= Login / room ======= */
function login(){
  username = document.getElementById('usernameInput').value.trim();
  room = document.getElementById('roomInput').value.trim() || 'default';
  if (!username) return alert('Vui lòng nhập tên!');
  socket.emit('user_online', { name: username, room });
  document.getElementById('loginPanel').classList.add('hidden');
  document.getElementById('mainPanel').classList.remove('hidden');
  document.getElementById('userLabel').textContent = `👤 ${username}`;
  showStatus('Đang chờ peer...');
}

/* ======= Media controls ======= */
function toggleCamera(){
  if (!videoTrack) { startMedia(true, false); return; }
  videoTrack.enabled = !videoTrack.enabled;
  document.getElementById('camBtn').textContent = videoTrack.enabled ? '📷 Tắt Camera' : '📷 Bật Camera';
}
function toggleMic(){
  if (!audioTrack) { startMedia(false, true); return; }
  audioTrack.enabled = !audioTrack.enabled;
  document.getElementById('micBtn').textContent = audioTrack.enabled ? '🎙️ Tắt Mic' : '🎙️ Bật Mic';
}

function startMedia(useVideo=true, useAudio=true){
  navigator.mediaDevices.getUserMedia({ video: useVideo, audio: useAudio })
    .then(stream => {
      localStream = stream;
      document.getElementById('localVideo').srcObject = stream;
      if (useVideo){ videoTrack = stream.getVideoTracks()[0]; document.getElementById('camBtn').textContent = '📷 Tắt Camera'; }
      if (useAudio){ audioTrack = stream.getAudioTracks()[0]; document.getElementById('micBtn').textContent = '🎙️ Tắt Mic'; detectSpeaking(stream); }
      if (peerConnection){ stream.getTracks().forEach(t => peerConnection.addTrack(t, stream)); }
    }).catch(e => { alert('Không thể truy cập media: ' + e); console.error(e); });
}

function detectSpeaking(stream){
  try{
    const ctx = new AudioContext();
    const source = ctx.createMediaStreamSource(stream);
    const analyser = ctx.createAnalyser();
    analyser.fftSize = 256;
    const data = new Uint8Array(analyser.frequencyBinCount);
    source.connect(analyser);
    function checkVolume(){ analyser.getByteFrequencyData(data); const volume = data.reduce((a,b)=>a+b,0)/data.length; document.getElementById('activityLabel').classList.toggle('hidden', volume < 10); requestAnimationFrame(checkVolume); }
    checkVolume();
  }catch(e){ console.warn('detectSpeaking err', e); }
}

/* ======= WebRTC: create PC, offer/answer, ICE ======= */
function startConnection(doOffer=false){
  if (peerConnection) return;
  peerConnection = new RTCPeerConnection(config);
  if (localStream) localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));

  peerConnection.ontrack = e => { document.getElementById('remoteVideo').srcObject = e.streams[0]; };
  peerConnection.onicecandidate = e => { if (e.candidate) socket.emit('ice_candidate', { candidate: e.candidate, to: currentPeerName }); };
  peerConnection.onconnectionstatechange = () => { showStatus('Peer: ' + peerConnection.connectionState); };

  if (doOffer){
    peerConnection.createOffer().then(offer => peerConnection.setLocalDescription(offer))
      .then(() => { socket.emit('offer', { offer: peerConnection.localDescription, to: currentPeerName, from: username }); });
  }
}

/* ======= File sending (chunked) ======= */
function sendFile(){
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files[0];
  if (!file) return alert('Chọn một file để gửi.');
  // small files can be sent at once, big files chunked
  if (file.size <= 512*1024){
    const reader = new FileReader();
    reader.onload = () => socket.emit('send_file', { from: username, name: file.name, type: file.type, data: reader.result });
    reader.readAsDataURL(file);
    return;
  }
  sendFileChunked(file);
}

function sendFileChunked(file){
  const CHUNK = 256 * 1024; // 256KB
  let offset = 0;
  const reader = new FileReader();
  document.getElementById('progressContainer').classList.remove('hidden');

  reader.onload = e => {
    const chunkData = e.target.result;
    const last = (offset + CHUNK) >= file.size;
    socket.emit('file_chunk', { from: username, name: file.name, type: file.type, chunk: chunkData, offset, last });
    offset += CHUNK;
    const percent = Math.min(100, Math.round((offset / file.size)*100));
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressEstimate').textContent = percent + '%';
    if (offset < file.size) readNext(); else setTimeout(()=>document.getElementById('progressContainer').classList.add('hidden'), 800);
  };
  function readNext(){ const slice = file.slice(offset, offset + CHUNK); reader.readAsDataURL(slice); }
  readNext();
}

/* ======= Chat send ======= */
function sendMessage(){
  const msg = document.getElementById('messageInput').value.trim();
  if (!msg) return;
  socket.emit('send_message', { from: username, text: msg, room });
  document.getElementById('messageInput').value = '';
  const chat = document.getElementById('chatBox');
  const p = document.createElement('div'); p.className='chat-bubble self'; p.innerHTML = `<strong>${escapeHtml(username)}:</strong> ${escapeHtml(msg)}`; chat.appendChild(p); chat.scrollTop = chat.scrollHeight;
}

/* ======= File receive handlers (server should forward assembled file or chunk events) ======= */
socket.on('receive_file', data => {
  const chat = document.getElementById('chatBox');
  const { from, name, type, data: fileData } = data;
  const p = document.createElement('div'); p.className='chat-bubble other';
  if (type.startsWith('image/')) p.innerHTML = `<strong>${escapeHtml(from)}:</strong><br/><img src="${fileData}" alt="${escapeHtml(name)}" class="max-h-32 mt-1 rounded-md" />`;
  else if (type.startsWith('video/')) p.innerHTML = `<strong>${escapeHtml(from)}:</strong><br/><video controls src="${fileData}" class="max-h-48 mt-1 rounded-md"></video>`;
  else p.innerHTML = `<strong>${escapeHtml(from)}:</strong><br/><a href="${fileData}" download="${escapeHtml(name)}" class="text-blue-500 underline">📎 ${escapeHtml(name)}</a>`;
  chat.appendChild(p); chat.scrollTop = chat.scrollHeight;
});

/* ======= Simple UI helpers ======= */
document.getElementById('scrollToBottom').addEventListener('click', ()=>{ const c=document.getElementById('chatBox'); c.scrollTop = c.scrollHeight; });

// theme toggle simple
document.getElementById('themeToggle').addEventListener('click', ()=> document.body.classList.toggle('dark'));

</script>
</body>
</html>
