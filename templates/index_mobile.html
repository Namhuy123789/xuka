<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XUKA 4.0</title>
  <meta name="csrf-token" content="DUMMY_CSRF_TOKEN"> <!-- Thay b·∫±ng token th·∫≠t t·ª´ backend -->

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Html5Qrcode -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <!-- DOMPurify -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <!-- MathJax -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" async></script>

  <style>
    body {
      background-image: url("");
      background-size: cover;
      background-position: center;
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
    }
    .banner {
      background: linear-gradient(90deg, #4facfe, #00f2fe);
      color: #fff;
      padding: 20px;
      text-align: center;
      font-size: 25px;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
    }
    .card {
      background: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 1.25rem;
    }
    .hidden {
      display: none !important;
    }
    .result-scrollable {
      max-height: 70vh; /* TƒÉng chi·ªÅu cao t·ªëi ƒëa ƒë·ªÉ tr√°nh tr√†n tr√™n mobile */
      overflow: auto;
      border: 1px solid #e5e7eb;
      padding: 1rem;
      border-radius: 0.5rem;
    }

    /* Khung camera */
    .camera-box {
      position: relative;
      width: min(90vw, 270px);
      aspect-ratio: 1/1;
      margin: 12px auto;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
      background: rgba(0, 0, 0, 0.6);
      touch-action: none; /* C·∫£i thi·ªán tr·∫£i nghi·ªám c·∫£m ·ª©ng */
    }
    #reader, #reader video, #reader canvas {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
      border-radius: 12px;
    }

    /* √î ƒë·ªãnh v·ªã QR */
    .qr-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    .qr-frame {
      width: 230px;
      height: 230px;
      border: 2px solid rgba(0, 147, 255, 0.95);
      border-radius: 10px;
      box-shadow: 
        0 0 15px rgba(0, 147, 255, 0.9),
        0 0 35px rgba(0, 147, 255, 0.7),
        0 0 60px rgba(0, 147, 255, 0.5),
        0 0 0 9999px rgba(0, 0, 0, 0.35) inset;
      position: relative;
    }

    /* Scan line */
    .scan-line {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 6px;
      background: linear-gradient(90deg, transparent, #00BFFF, transparent);
      animation: scanMove 2.2s linear infinite;
      border-radius: 3px;
      box-shadow: 
        0 0 15px rgba(0, 147, 255, 0.9),
        0 0 35px rgba(0, 147, 255, 0.7),
        0 0 60px rgba(0, 147, 255, 0.5);
    }
    @keyframes scanMove {
      0% { top: 0; opacity: 0.85; }
      50% { opacity: 1; }
      100% { top: calc(100% - 6px); opacity: 0.85; }
    }

    /* Responsive adjustments */
    @media (max-width: 640px) {
      .banner {
        font-size: 20px;
      }
      .result-scrollable {
        max-height: 50vh;
      }
      .camera-box {
        width: 80vw;
      }
    }
  </style>
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
</head>
<body>
  <!-- Banner -->
  <div class="banner">
    <h1>
      <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/xuka.ico" 
     class="w-11 h-11 inline-block neon-bluewhite mr-2" 
     alt="Xuka">
<style>
.neon-bluewhite {
  filter: drop-shadow(0 0 4px #aafcff)
          drop-shadow(0 0 8px #ffffff)
          drop-shadow(0 0 12px #aafcff)
          drop-shadow(0 0 18px #ffffff);
}
</style>
      <span class="text-3xl font-bold">XUKA 4.0</span>
      <span class="text-lg font-bold ml-2 text-yellow-300">xuka.com.vn</span><br>
      <span class="text-base font-semibold">PH·∫¶N M·ªÄM T·ªî CH·ª®C C√ÅC K·ª≤ THI - KI·ªÇM TRA</span>
    </h1>
  </div>

  <!-- Navbar -->
  <nav class="bg-yellow-300 py-1 shadow-md">
    <div class="flex items-center px-4 space-x-3">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/21/Flag_of_Vietnam.svg/1024px-Flag_of_Vietnam.svg.png"
           alt="C·ªù Vi·ªát Nam" class="h-6 w-8 rounded-sm shadow" aria-label="C·ªù Vi·ªát Nam">
      <div class="w-full max-w-[800px] h-8 flex items-center">
        <span class="text-blue-500 font-bold text-sm whitespace-nowrap">
          TR∆Ø·ªúNG THPT PH∆Ø·ªöC LONG - ƒê·ªíNG NAI
        </span>
      </div>
    </div>
  </nav>

  <!-- N·ªôi dung ch√≠nh -->
  <div class="flex flex-col sm:flex-row justify-center items-start gap-6 sm:gap-8 px-4 sm:px-8 mt-3">
    <!-- C·ªôt tr√°i (·∫©n tr√™n mobile) -->
    <aside id="left-column" class="hidden sm:flex flex-col gap-3 w-full sm:w-1/4">
      <div class="card">
        <h2 class="text-xl font-bold text-blue-800 border-b pb-2 mb-3">üì∞ Tin m·ªõi t·ª´ VnExpress</h2>
        <ul class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <li>
            üåç <a href="https://vnexpress.net/the-gioi" target="_blank" rel="noopener" class="text-blue-600 font-semibold hover:underline">Tin t·ª©c th·∫ø gi·ªõi</a><br>
            <span class="text-gray-500">T·ªïng h·ª£p nhanh nh·ªØng di·ªÖn bi·∫øn ch√≠nh tr·ªã, kinh t·∫ø, x√£ h·ªôi n·ªïi b·∫≠t tr√™n th·∫ø gi·ªõi.</span>
          </li>
        </ul>
      </div>
      <div class="card">
        <ul class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <li class="flex items-center gap-2">
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/xuka.ico" alt="Bi·ªÉu t∆∞·ª£ng Xuka" class="w-4 h-4">
            <a href="https://xuka.com.vn/huongdan" target="_blank" rel="noopener" class="text-blue-600 font-semibold hover:underline">xuka.com.vn</a>
          </li>
        </ul>
        <section class="pt-4 border-t">
          <div class="grid grid-cols-1 gap-4">
            <iframe class="rounded-lg w-full aspect-video" src="https://www.youtube.com/embed/FxIGbF24gkU" title="Video h∆∞·ªõng d·∫´n 1" loading="lazy" allowfullscreen></iframe>
          </div>
        </section>
      </div>
    </aside>

    <!-- C·ªôt ch√≠nh -->
    <main id="main-column" class="flex flex-col gap-4 w-full sm:max-w-md mt-1">
      <!-- ƒêƒÉng nh·∫≠p b·∫±ng QR -->
      <section id="qr-login" class="bg-white p-6 rounded-xl shadow text-center">
        <h1 class="text-xl font-bold text-pink-500 mb-4">QU√âT M√É QR</h1>
        <div class="camera-box">
          <div id="reader"></div>
          <div class="qr-overlay" id="qrOverlay">
            <div class="qr-frame">
              <div class="scan-line"></div>
            </div>
          </div>
        </div>
        <p id="qr-error" class="text-red-600 mt-2 font-semibold hidden">QR kh√¥ng h·ª£p l·ªá!</p>
        <input type="file" id="qr-file" accept="image/*" class="hidden" />

        <div class="flex justify-center gap-4 mt-4">
          <button id="flip-camera" 
                  class="flex items-center justify-center gap-2 px-4 py-2 rounded-xl text-white font-semibold
                         bg-gradient-to-r from-green-400 via-teal-500 to-blue-500
                         shadow-lg transform transition-all duration-200
                         hover:scale-105 hover:shadow-2xl active:scale-95 active:shadow-inner"
                  aria-label="Chuy·ªÉn camera">
            <span class="border-2 border-white rounded-full p-1 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6M20 20v-6h-6M4 14a8 8 0 0116 0 8 8 0 01-16 0z"/>
              </svg>
            </span>
          </button>
          <button id="upload-qr" 
                  class="flex items-center justify-center gap-2 px-4 py-2 rounded-xl text-white font-semibold
                         bg-gradient-to-r from-green-400 via-teal-500 to-blue-500
                         shadow-lg transform transition-all duration-200
                         hover:scale-105 hover:shadow-2xl active:scale-95 active:shadow-inner"
                  aria-label="T·∫£i l√™n m√£ QR">
            <span class="border-2 border-white rounded-full p-1 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 7h4l3-3h4l3 3h4v14H3V7z" />
                <circle cx="12" cy="13" r="4" stroke="white" stroke-width="2" />
              </svg>
            </span>
          </button>
        </div>
      </section>

      <!-- Nh√≥m n√∫t -->
      <div id="button-group" class="flex flex-wrap justify-center gap-4">
        <a href="/tronde" 
           class="flex items-center justify-center gap-2 px-5 py-2.5 rounded-xl text-white font-semibold
                  bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500
                  shadow-lg transform transition-all duration-200
                  hover:scale-105 hover:shadow-2xl active:scale-95 active:shadow-inner"
           aria-label="Qu·∫£n tr·ªã">
          <span class="border-2 border-white rounded-full p-1 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" 
                 viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" 
                    d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4
                       4-1.79 4-4-1.79-4-4-4zm8 4a8 8 0 11-16 0 
                       8 8 0 0116 0z" />
            </svg>
          </span>
        </a>
        <a href="/xuka" 
           class="flex items-center justify-center gap-2 px-5 py-2.5 rounded-xl text-white font-semibold
                  bg-gradient-to-r from-green-400 via-teal-500 to-blue-500
                  shadow-lg transform transition-all duration-200
                  hover:scale-105 hover:shadow-2xl active:scale-95 active:shadow-inner"
           aria-label="ƒê√°nh gi√°">
          <span class="border-2 border-white rounded-full p-1 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" 
                 viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" 
                    d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.28 3.945a1 
                       1 0 00.95.69h4.15c.969 0 1.371 1.24.588 
                       1.81l-3.36 2.44a1 1 0 00-.364 1.118l1.28 
                       3.945c.3.921-.755 1.688-1.54 1.118l-3.36-2.44a1 
                       1 0 00-1.175 0l-3.36 2.44c-.785.57-1.84-.197-1.54-1.118l1.28-3.945a1 
                       1 0 00-.364-1.118l-3.36-2.44c-.783-.57-.38-1.81.588-1.81h4.15a1 
                       1 0 00.95-.69l1.28-3.945z" />
            </svg>
          </span>
        </a>
        <a href="/huongdan" 
           class="flex items-center justify-center gap-2 px-5 py-2.5 rounded-xl text-white font-semibold
                  bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500
                  shadow-lg transform transition-all duration-200
                  hover:scale-105 hover:shadow-2xl active:scale-95 active:shadow-inner"
           aria-label="H∆∞·ªõng d·∫´n">
          <span class="border-2 border-white rounded-full p-1 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" 
                 viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" 
                    d="M12 6l-2-2H5a2 2 0 00-2 2v14a2 2 0 
                       002 2h14a2 2 0 002-2V6a2 2 0 
                       00-2-2h-5l-2 2z" />
            </svg>
            H∆∞·ªõng d·∫´n
          </span>
        </a>
      </div>
    </main>

    <!-- C·ªôt ph·∫£i (·∫©n tr√™n mobile) -->
    <aside id="right-column" class="hidden sm:flex flex-col gap-3 w-full sm:w-1/4">
      <div class="card">
        <h2 class="text-xl font-bold text-blue-800 border-b pb-2 mb-3">üì∞ S·ªû GD&ƒêT ƒê·ªíNG NAI</h2>
        <ul class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <li>üåç <a href="https://dnis.dongnai.gov.vn/" target="_blank" rel="noopener" class="text-blue-600 font-semibold hover:underline">H·ªá th·ªëng vƒÉn b·∫£n</a><br><span class="text-gray-500">H·ªá th·ªëng vƒÉn b·∫£n ch·ªâ ƒë·∫°o ƒëi·ªÅu h√†nh ng√†nh GD&ƒêT ƒê·ªìng Nai.</span></li>
        </ul>
      </div>
      <div class="card">
        <ul class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <li class="flex items-center gap-2">
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/xuka.ico" alt="Bi·ªÉu t∆∞·ª£ng Xuka" class="w-4 h-4">
            <a href="https://xuka.com.vn/huongdan" target="_blank" rel="noopener" class="text-blue-600 font-semibold hover:underline">xuka.com.vn</a>
          </li>
        </ul>
        <section class="pt-4 border-t">
          <div class="grid grid-cols-1 gap-4">
            <iframe class="rounded-lg w-full aspect-video" src="https://www.youtube.com/embed/l_4eslm2VEY" title="Video h∆∞·ªõng d·∫´n 2" loading="lazy" allowfullscreen></iframe>
          </div>
        </section>
      </div>
    </aside>
  </div>

  <!-- ƒêƒÉng nh·∫≠p t√†i kho·∫£n -->
  <section id="account-login" class="max-w-md mx-auto bg-white p-6 rounded shadow hidden">
    <h1 class="text-2xl font-bold mb-4">ƒêƒÉng Nh·∫≠p T√†i Kho·∫£n</h1>
    <form id="account-login-form">
      <div class="mb-4">
        <label for="username" class="block font-semibold">T√™n ƒëƒÉng nh·∫≠p:</label>
        <input id="username" name="username" type="text" class="w-full border p-2 rounded" autocomplete="username" />
      </div>
      <div class="mb-4">
        <label for="password" class="block font-semibold">M·∫≠t kh·∫©u:</label>
        <input id="password" name="password" type="password" class="w-full border p-2 rounded" autocomplete="current-password" />
      </div>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ƒêƒÉng nh·∫≠p</button>
      <p id="login-error" class="text-red-600 mt-2 font-semibold hidden">Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!</p>
    </form>
  </section>

  <!-- Th√¥ng tin th√≠ sinh -->
  <section id="login-form" class="max-w-xl mx-auto bg-white p-6 rounded shadow hidden">
    <h1 class="text-2xl font-bold mb-4">Th√¥ng Tin Th√≠ Sinh</h1>
    <div class="mb-4">
      <label for="hoten" class="block font-semibold">H·ªç v√† t√™n:</label>
      <input id="hoten" name="hoten" type="text" class="w-full border p-2 rounded" />
    </div>
    <div class="mb-4">
      <label for="sbd" class="block font-semibold">S·ªë b√°o danh:</label>
      <input id="sbd" name="sbd" type="text" class="w-full border p-2 rounded" />
    </div>
    <div class="mb-4">
      <label for="ngaysinh" class="block font-semibold">Ng√†y sinh:</label>
      <input id="ngaysinh" name="ngaysinh" type="date" class="w-full border p-2 rounded" />
    </div>
    <div class="mb-4">
      <label for="made" class="block font-semibold">M√£ ƒë·ªÅ:</label>
      <select id="made" name="made" class="w-full border p-2 rounded">
        <option value="">-- Ch·ªçn m√£ ƒë·ªÅ --</option>
      </select>
    </div>
    <button id="btn-start-exam" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">B·∫Øt ƒë·∫ßu thi</button>
  </section>

  <!-- B√†i thi -->
  <section id="exam-container" class="max-w-3xl mx-auto bg-white p-6 rounded shadow hidden">
    <h1 class="text-2xl font-bold mb-4 text-center">B√ÄI THI TR·∫ÆC NGHI·ªÜM</h1>
    <p id="countdown" class="text-red-600 font-bold mb-4">Th·ªùi gian: --:--</p>
    <div id="questions" class="space-y-4 mb-6"></div>
    <button id="btn-submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">N·ªôp b√†i</button>
    <p id="result" class="mt-4 text-green-600 font-bold"></p>
  </section>

  <!-- K·∫øt qu·∫£ -->
  <section id="result-container" class="max-w-2xl mx-auto p-6 bg-white rounded shadow mt-10 hidden"></section>

  <footer class="mt-10 py-4 text-center text-gray-700 text-sm font-medium">
    B·∫£n quy·ªÅn ¬© 2025 <span class="font-bold text-red-600">PH·∫†M HUY TU√ÇN</span> ¬∑ ƒêT: <a href="tel:0389897989" class="text-blue-600 hover:underline">0389 897 989</a>
  </footer>

  <script>
    // ====== C·∫§U H√åNH & BI·∫æN TO√ÄN C·ª§C ======
    const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://127.0.0.1:5000' : 'https://xuka.com.vn';

    let time = 0;
    let timer = null;
    let questionData = [];
    let examDeadline = null;
    let currentMade = '';

    // ===== Hi·ªáu ·ª©ng qu√©t th√†nh c√¥ng =====
    function showSuccessEffect(message = "Qu√©t th√†nh c√¥ng!") {
      const div = document.createElement("div");
      div.innerText = message;
      div.className = "fixed top-5 right-5 bg-green-500 text-white px-4 py-2 rounded-xl shadow-lg animate-bounce z-50";
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 2000);
    }

    // ===== TI·ªÜN √çCH ======
    const qs = (sel) => document.querySelector(sel);
    const qsa = (sel) => Array.from(document.querySelectorAll(sel));
    const csrf = () => (qs('meta[name="csrf-token"]')?.content || '');
    const safeHTML = (html) => DOMPurify.sanitize(String(html || ''), { USE_PROFILES: { html: true } });
    const nsKey = (key) => `xuka_${currentMade || 'unknown'}_${key}`;
    const typeset = (el) => {
      if (window.MathJax?.typesetPromise) {
        MathJax.typesetPromise([el]).catch(err => console.error('MathJax Error:', err));
      }
    };

    // ====== QU√âT M√É QR ======
    let html5QrCode = null;
    let devices = [];
    let camIndex = 0;

    async function checkCameraPermission() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(t => t.stop());
        return true;
      } catch (err) {
        qs('#qr-error').textContent = 'Vui l√≤ng c·∫•p quy·ªÅn camera trong c√†i ƒë·∫∑t tr√¨nh duy·ªát!';
        qs('#qr-error').classList.remove('hidden');
        return false;
      }
    }

    async function ensureScanner() {
      if (!html5QrCode) html5QrCode = new Html5Qrcode('reader');
      return html5QrCode;
    }

    async function stopScanner() {
      if (html5QrCode) {
        try { await html5QrCode.stop(); } catch (_) {}
        try { await html5QrCode.clear(); } catch (_) {}
        html5QrCode = null;
      }
    }

    async function startQrScanner() {
      const readerElem = qs('#reader');
      if (!readerElem) return;
      await ensureScanner();
      const hasPerm = await checkCameraPermission();
      if (!hasPerm) return;

      try {
        const list = await Html5Qrcode.getCameras();
        devices = list || [];
        if (devices.length === 0) {
          qs('#qr-error').textContent = 'Kh√¥ng t√¨m th·∫•y camera tr√™n thi·∫øt b·ªã!';
          qs('#qr-error').classList.remove('hidden');
          return;
        }
        const camId = devices[camIndex]?.id || { facingMode: 'environment' };
        await html5QrCode.start(camId, { fps: 10, qrbox: { width: 250, height: 250 } }, async (decodedText) => {
          console.log('M√£ QR ƒë∆∞·ª£c gi·∫£i m√£:', decodedText);
          await stopScanner();
          await verifyAndLogin(decodedText);
        }, () => {});
      } catch (err) {
        qs('#qr-error').textContent = `L·ªói camera: ${err?.message || err}`;
        qs('#qr-error').classList.remove('hidden');
      }
    }

    qs('#flip-camera')?.addEventListener('click', async () => {
      if (!devices.length || !html5QrCode) return;
      camIndex = (camIndex + 1) % devices.length;
      try {
        await html5QrCode.stop();
        await html5QrCode.start(devices[camIndex].id, { fps: 10, qrbox: { width: 250, height: 250 } }, async (dt) => {
          console.log('M√£ QR ƒë∆∞·ª£c gi·∫£i m√£ (chuy·ªÉn camera):', dt);
          await stopScanner();
          await verifyAndLogin(dt);
        }, () => {});
      } catch (e) {
        console.error('Kh√¥ng ƒë·ªïi ƒë∆∞·ª£c camera:', e);
        qs('#qr-error').textContent = 'Kh√¥ng th·ªÉ ƒë·ªïi camera!';
        qs('#qr-error').classList.remove('hidden');
      }
    });

    const qrFileInput = qs('#qr-file');
    qs('#upload-qr')?.addEventListener('click', () => {
      qs('#qr-error').classList.add('hidden');
      qrFileInput.click();
    });

    qrFileInput?.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) {
        qs('#qr-error').textContent = 'Kh√¥ng c√≥ t·ªáp n√†o ƒë∆∞·ª£c ch·ªçn!';
        qs('#qr-error').classList.remove('hidden');
        return;
      }
      if (!file.type.startsWith('image/')) {
        qs('#qr-error').textContent = 'Vui l√≤ng ch·ªçn m·ªôt t·ªáp h√¨nh ·∫£nh!';
        qs('#qr-error').classList.remove('hidden');
        return;
      }
      await stopScanner();
      await ensureScanner();
      try {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        await new Promise((resolve, reject) => {
          img.onload = () => resolve();
          img.onerror = () => reject(new Error('Kh√¥ng th·ªÉ t·∫£i h√¨nh ·∫£nh!'));
        });
        const decoded = await html5QrCode.scanFile(file, false);
        console.log('M√£ QR ƒë∆∞·ª£c gi·∫£i m√£ t·ª´ t·ªáp:', decoded);
        URL.revokeObjectURL(img.src);
        await stopScanner();
        await verifyAndLogin(decoded);
      } catch (err) {
        qs('#qr-error').textContent = `Kh√¥ng th·ªÉ ƒë·ªçc m√£ QR t·ª´ ·∫£nh: ${err.message || err}`;
        qs('#qr-error').classList.remove('hidden');
      } finally {
        qrFileInput.value = '';
      }
    });

    async function verifyAndLogin(qrText) {
      qs('#qr-error').classList.add('hidden');
      if (!qrText) {
        qs('#qr-error').textContent = 'M√£ QR r·ªóng!';
        qs('#qr-error').classList.remove('hidden');
        return;
      }
      console.log('G·ª≠i m√£ QR ƒë·∫øn server:', qrText, 'CSRF Token:', csrf());
      try {
        const res = await fetch(`${API_BASE}/api/decrypt_qr`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf()
          },
          body: JSON.stringify({ qr_value: qrText.trim() })
        });
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          throw new Error(errorData.msg || `Ph·∫£n h·ªìi m√°y ch·ªß kh√¥ng th√†nh c√¥ng: ${res.status} ${res.statusText}`);
        }
        const data = await res.json();
        if (data.status === 'success') {
          showSuccessEffect();
          qs('#left-column').classList.add('hidden');
          qs('#right-column').classList.add('hidden');
          qs('#button-group').classList.add('hidden');
          qs('#qr-login').classList.add('hidden');
          qs('#account-login').classList.remove('hidden');
          qs('#account-login').scrollIntoView({ behavior: 'smooth' });
        } else {
          throw new Error(data.msg || 'M√£ QR kh√¥ng h·ª£p l·ªá!');
        }
      } catch (err) {
        console.error('L·ªói verifyAndLogin:', err);
        qs('#qr-error').textContent = err.message || 'L·ªói k·∫øt n·ªëi m√°y ch·ªß!';
        qs('#qr-error').classList.remove('hidden');
      }
    }

    qs('#account-login-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = qs('#username').value.trim();
      const password = qs('#password').value;
      if (!username || !password) {
        const x = qs('#login-error');
        x.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√†i kho·∫£n v√† m·∫≠t kh·∫©u!';
        x.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf() },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (data && (data.ok || data.status === 'success')) {
          qs('#account-login').classList.add('hidden');
          qs('#login-form').classList.remove('hidden');
          qs('#login-form').scrollIntoView({ behavior: 'smooth' });
          loadExamCodes();
        } else {
          throw new Error(data?.message || 'Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!');
        }
      } catch (err) {
        const x = qs('#login-error');
        x.textContent = err.message;
        x.classList.remove('hidden');
      }
    });

    async function loadExamCodes() {
      const select = qs('#made');
      try {
        const res = await fetch(`${API_BASE}/get_exam_codes`, { headers: { 'Accept': 'application/json', 'X-CSRFToken': csrf() } });
        const data = await res.json();
        const codes = Array.isArray(data) ? data : (data.codes || []);
        select.innerHTML = '<option value="">-- Ch·ªçn m√£ ƒë·ªÅ --</option>' + codes.map(c => `<option value="${c}">${c}</option>`).join('');
      } catch (err) {
        const p = document.createElement('p');
        p.className = 'text-red-600 mt-2 font-semibold';
        p.textContent = 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch m√£ ƒë·ªÅ. Vui l√≤ng th·ª≠ l·∫°i!';
        select.parentElement.appendChild(p);
      }
    }

    qs('#btn-start-exam')?.addEventListener('click', startExam);

    async function startExam() {
      const name = qs('#hoten').value.trim();
      const sbd = qs('#sbd').value.trim();
      const dob = qs('#ngaysinh').value;
      const made = qs('#made').value;
      if (!name || !sbd || !dob || !made) {
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß H·ªç t√™n, SBD, Ng√†y sinh v√† M√£ ƒë·ªÅ!');
        return;
      }

      currentMade = made;
      qs('#login-form').classList.add('hidden');
      qs('#exam-container').classList.remove('hidden');

      try {
        const res = await fetch(`${API_BASE}/exam_session?made=${encodeURIComponent(made)}`, { headers: { 'Accept': 'application/json', 'X-CSRFToken': csrf() } });
        const data = await res.json();
        if (data?.deadline) { examDeadline = Number(data.deadline); }
        const duration = Number(data?.duration_sec || 3600);
        if (!examDeadline) { examDeadline = Date.now() + duration * 1000; }
      } catch (_) {
        examDeadline = Date.now() + 3600 * 1000;
      }

      updateCountdown();
      timer = setInterval(updateCountdown, 1000);

      try {
        const res = await fetch(`${API_BASE}/get_questions?made=${encodeURIComponent(made)}`, { headers: { 'Accept': 'application/json' } });
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error('D·ªØ li·ªáu c√¢u h·ªèi kh√¥ng ph·∫£i m·∫£ng');
        questionData = processAllQuestions(data);
        renderQuestions(questionData);
        restoreAnswers();
      } catch (err) {
        const jsonFile = `/questions/questions${made}.json`;
        try {
          const res = await fetch(jsonFile, { headers: { 'Accept': 'application/json' } });
          if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
          const data = await res.json();
          if (!Array.isArray(data)) throw new Error('D·ªØ li·ªáu c√¢u h·ªèi kh√¥ng ph·∫£i m·∫£ng');
          questionData = processAllQuestions(data);
          renderQuestions(questionData);
          restoreAnswers();
        } catch (e) {
          console.error('L·ªói t·∫£i c√¢u h·ªèi:', e);
          alert(`Kh√¥ng th·ªÉ t·∫£i c√¢u h·ªèi: ${e.message}`);
        }
      }
    }

    function updateCountdown() {
      const now = Date.now();
      const remainMs = Math.max(0, (examDeadline || now) - now);
      const remain = Math.floor(remainMs / 1000);
      const m = String(Math.floor(remain / 60)).padStart(2, '0');
      const s = String(remain % 60).padStart(2, '0');
      qs('#countdown').innerText = `Th·ªùi gian: ${m}:${s}`;
      localStorage.setItem(nsKey('savedTime'), remain);
      if (remain <= 0) {
        clearInterval(timer);
        submitExam(true);
      }
    }

    function applyGeneralFormatting(s) {
      s = String(s || "");
      s = s.replace(/‚àí/g, "-").replace(/œÄ/g, "\\pi");
      s = s.replace(/(\d+)\s*\n\s*(\+|\-|\)|\*|\/|\^)/g, "$1 $2");
      s = s.replace(/(\^)\s*\n\s*(\d+)/g, "$1$2");
      s = s.replace(/([a-zA-Z])\s*\n\s*([a-zA-Z])/g, "$1 $2");
      s = s.replace(/^\s+/gm, "");
      s = s.replace(/(^|\.\s+)([^\s])/g, (_, pre, ch) => pre + ch);
      s = s.replace(/\s{2,}/g, " ").trim();
      s = s.replace(/C√¢u\s*(\d+)\s*\.(?!\s)/gi, "C√¢u $1. ");
      s = s.replace(/([.,;:!?])([^\s])/g, "$1 $2");
      s = s.replace(/([a-zA-Z])(\d)/g, "$1 $2");
      s = s.replace(/(\d)([a-zA-Z])/g, "$1 $2");
      s = s.replace(/\s*([+\-*/=])\s*/g, " $1 ");
      const subMap = { '‚ÇÄ': '0', '‚ÇÅ': '1', '‚ÇÇ': '2', '‚ÇÉ': '3', '‚ÇÑ': '4', '‚ÇÖ': '5', '‚ÇÜ': '6', '‚Çá': '7', '‚Çà': '8', '‚Çâ': '9' };
      s = s.replace(/[\u2080-\u2089]/g, m => subMap[m] || m);
      return s;
    }

    function processMathContent(content) {
      let s = applyGeneralFormatting(content);
      s = s.replace(/([^\s])‚à´/g, "$1 ‚à´");
      s = s.replace(/‚à´([^\s])/g, "‚à´ $1");
      s = s.replace(/([^\s])dx\b/gi, "$1 dx");
      s = s.replace(/\b(sin|cos|tan|cot|sec|csc|arctan|arcsin|arccos|ln|log)\s*([A-Za-z0-9\\pi])/gi, "$1 $2");
      s = s.replace(/\bGi·∫£ih·ªáb·∫•tph∆∞∆°ngtr√¨nh\b/gi, "Gi·∫£i h·ªá b·∫•t ph∆∞∆°ng tr√¨nh");
      s = s.replace(/\bGi·∫£ib·∫•tph∆∞∆°ngtr√¨nh\b/gi, "Gi·∫£i b·∫•t ph∆∞∆°ng tr√¨nh");
      s = s.replace(/\blog(\d+)\(([^)]+)\)/gi, (_, base, arg) => `\\log_{${base}}(${arg.trim()})`);
      s = s.replace(/\blog\(([^)]+)\)/gi, (_, arg) => `\\log(${arg.trim()})`);
      s = s.replace(/ln\(([^)]+)\)/gi, (_, arg) => `\\ln(${arg.trim()})`);
      s = s.replace(/frac\(([^,]+),([^)]+)\)/gi, (_, a, b) => `\\frac{${a.trim()}}{${b.trim()}}`);
      s = s.replace(/\b([A-Za-z0-9]+)\/([A-Za-z0-9]+)\b/g, (_, a, b) => `\\frac{${a}}{${b}}`);
      s = s.replace(/sqrt\[(\d+)\]\(([^)]+)\)/gi, (_, n, val) => `\\sqrt[${n}]{${val.trim()}}`);
      s = s.replace(/sqrt\(([^)]+)\)/gi, (_, val) => `\\sqrt{${val.trim()}}`);
      s = s.replace(/([A-Za-z])_(\d+)/g, (_, base, sub) => `${base}_{${sub}}`);
      s = s.replace(/([A-Za-z0-9])\^(\d+)/g, (_, base, sup) => `${base}^{${sup}}`);
      s = s.replace(/int_([^_]+)(?:_([^_]+))?([^]*?)(?=\s|$)/gi, (_, from, to, body) =>
        `\\int${from ? `_{${from}}` : ""}${to ? `^{${to}}` : ""}${body.trim()}`
      );
      s = s.replace(/sum_([^_]+)(?:_([^_]+))?([^]*?)(?=\s|$)/gi, (_, from, to, body) =>
        `\\sum${from ? `_{${from}}` : ""}${to ? `^{${to}}` : ""}${body.trim()}`
      );
      s = s.replace(/lim_([^_]+)([^]*?)(?=\s|$)/gi, (_, limit, body) => `\\lim_{${limit}}${body.trim()}`);
      s = s.replace(/d\/dx\(([^)]+)\)/gi, (_, expr) => `\\frac{d}{dx}(${expr.trim()})`);
      s = s.replace(/\be\s*\(\s*([^)]+?)\s*\)/g, (_, p1) => `e^{${p1.replace(/\s+/g, "")}}`);
      s = s.replace(/\be\^\s*\(\s*([^)]+?)\s*\)/g, (_, p1) => `e^{${p1.replace(/\s+/g, "")}}`);
      s = s.replace(/(?<!\\frac\{)1\s*\/\s*([a-zA-Z0-9\\pi\+\-\*\/]+)/g, "\\frac{1}{$1}");
      s = s.replace(/‚à´\s*t·ª´\s*([^\s]+)\s*ƒë·∫øn\s*([^\s]+)\s*c·ªßa\s*\(?\s*([^)]+?)\s*\)?\s*dx/gi,
        (_, a, b, expr) => `\\int_{${a.replace(/œÄ/g, "\\pi")}}^{${b.replace(/œÄ/g, "\\pi")}} ${expr.trim()} \\, dx`
      );
      s = s.replace(/‚à´\s*([^\n\r]+?)\s*dx\b/gi, (_, expr) => `\\int ${expr.trim()} \\, dx`);
      return s;
    }

    function processPhysicsContent(content) {
      let s = applyGeneralFormatting(content);
      s = s.replace(/vec\{(\w+)\}/gi, (_, v) => `\\vec{${v}}`);
      s = s.replace(/\|vec\{(\w+)\}\|/gi, (_, v) => `|\\vec{${v}}|`);
      s = s.replace(/Delta/g, "\\Delta");
      s = s.replace(/nabla/g, "\\nabla");
      s = s.replace(/(\w+)_(\w+)/g, (_, base, sub) => `${base}_{${sub}}`);
      s = s.replace(/(\w+)\^(\w+)/g, (_, base, sup) => `${base}^{${sup}}`);
      return s;
    }

    function processChemistryContent(content) {
      let s = applyGeneralFormatting(content);
      s = s.replace(/H_2O/g, "\\ce{H2O}");
      s = s.replace(/CO_2/g, "\\ce{CO2}");
      s = s.replace(/([A-Z][a-z]?)_(\d+)/g, (_, elem, num) => `\\ce{${elem}${num}}`);
      s = s.replace(/([A-Z][a-z]?)(\d+)/g, "\\ce{$1_$2}");
      s = s.replace(/([A-Z][a-z]?)[\s]*([0-9]+)/g, (_, elem, num) => `${elem}${num}`);
      const chemRegex = /(?:[A-Z][a-z]?\d*|\([A-Z][a-z]?\d*\)\d*)(?:\s*(?:[A-Z][a-z]?\d*|\([A-Z][a-z]?\d*\)\d*))*/g;
      s = s.replace(chemRegex, match => {
        if (/^[A-Za-z\s]+$/.test(match)) return match;
        return `\\ce{${match}}`;
      });
      return s;
    }

    function processExamContent(content) {
      let s = applyGeneralFormatting(content);
      s = processMathContent(s);
      s = processPhysicsContent(s);
      s = processChemistryContent(s);
      const patterns = [
        /\\int[\s\S]*?\\,\s*dx/g,
        /\\frac\{[^}]+\}\{[^}]+\}/g,
        /\\sqrt(?:\[[^\]]+\])?\{[^}]+\}/g,
        /\\log_\{\d+\}\([^)]*\)/g,
        /\b(?:log\d*|log|ln|sin|cos|tan|exp)\([^)]*\)/gi,
        /[A-Za-z0-9]+_\{\d+\}/g,
        /[A-Za-z0-9]\^\{\d+\}/g,
        /\\ce\{[^}]+\}/g,
        /\\Delta/g,
        /\\nabla/g,
        /e\^\{[^}]+\}/g
      ];
      patterns.forEach((pattern) => {
        s = s.replace(pattern, function (match, ...args) {
          const offset = args[args.length - 2];
          const str = args[args.length - 1];
          if (isInsideMath(str, offset)) return match;
          if (/^\\\(.*\\\)$/.test(match)) return match;
          return `\\(${match}\\)`;
        });
      });
      s = s.replace(/\s{2,}/g, " ").trim();
      return s;
    }

    function isInsideMath(str, offset) {
      const upto = str.slice(0, offset);
      const lastOpen = upto.lastIndexOf("\\(");
      const lastClose = upto.lastIndexOf("\\)");
      return lastOpen > lastClose;
    }

    function processAllQuestions(questions) {
      return questions.map(q => {
        const qq = { ...q };
        qq.noi_dung = processExamContent(qq.noi_dung);
        if (qq.lua_chon && typeof qq.lua_chon === 'object') {
          for (const k in qq.lua_chon) {
            if (Object.prototype.hasOwnProperty.call(qq.lua_chon, k)) {
              qq.lua_chon[k] = processExamContent(qq.lua_chon[k]);
            }
          }
        }
        qq.dap_an_dung = qq.dap_an_dung ? String(qq.dap_an_dung).trim() : '';
        qq.goi_y_dap_an = qq.goi_y_dap_an ? processExamContent(qq.goi_y_dap_an) : '';
        return qq;
      });
    }

    function getAnswerValue(index) {
      const q = questionData[index];
      if ((q.kieu_cau_hoi || '').toLowerCase() === 'tu_luan') {
        const ta = qs(`#q${index}`);
        return ta ? ta.value.trim() : '';
      } else {
        const radios = qsa(`input[name="q${index}"]`);
        for (const r of radios) {
          if (r.checked) return r.value;
        }
        return '';
      }
    }

    function renderQuestions(questions) {
      const container = qs('#questions');
      container.innerHTML = '';
      const unansweredLabel = document.createElement('p');
      unansweredLabel.id = 'unanswered-count';
      unansweredLabel.className = 'text-red-600 font-bold mb-4';
      container.appendChild(unansweredLabel);
      questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = 'mb-6 p-4 bg-gray-50 rounded-lg';
        const label = document.createElement('label');
        label.className = 'block font-semibold mb-2 text-lg';
        label.innerHTML = `C√¢u ${i + 1}: ${safeHTML(q.noi_dung)}`;
        div.appendChild(label);
        if ((q.kieu_cau_hoi || '').toLowerCase() === 'tu_luan') {
          const ta = document.createElement('textarea');
          ta.id = `q${i}`;
          ta.rows = 4;
          ta.placeholder = 'Nh·∫≠p c√¢u tr·∫£ l·ªùi...';
          ta.className = 'border p-2 w-full rounded-md';
          div.appendChild(ta);
        } else if (q.lua_chon) {
          const wrap = document.createElement('div');
          wrap.className = 'border rounded-md p-2 max-h-40 overflow-y-auto space-y-2';
          Object.entries(q.lua_chon).forEach(([k, v]) => {
            const row = document.createElement('div');
            row.className = 'flex items-start gap-2 min-w-max';
            const id = `q${i}_${k}`;
            row.innerHTML = `
              <input type="radio" name="q${i}" id="${id}" value="${k}" class="mt-1">
              <label for="${id}" class="overflow-x-auto block" style="max-width: calc(100% - 30px);">${safeHTML(`${k}. ${v}`)}</label>
            `;
            wrap.appendChild(row);
          });
          div.appendChild(wrap);
        }
        container.appendChild(div);
      });
      function updateUnansweredCount() {
        let unanswered = 0;
        questions.forEach((q, i) => {
          const sel = getAnswerValue(i);
          if (!sel) unanswered++;
        });
        unansweredLabel.textContent = `C√¢u ch∆∞a tr·∫£ l·ªùi: ${unanswered}`;
      }
      questions.forEach((q, i) => {
        if ((q.kieu_cau_hoi || '').toLowerCase() === 'tu_luan') {
          const ta = qs(`#q${i}`);
          if (ta) {
            ta.addEventListener('input', () => {
              const cur = JSON.parse(localStorage.getItem(nsKey('savedAnswers')) || '{}');
              cur[`q${i}`] = ta.value;
              localStorage.setItem(nsKey('savedAnswers'), JSON.stringify(cur));
              updateUnansweredCount();
            });
          }
        } else {
          const radios = qsa(`input[name="q${i}"]`);
          Array.from(radios).forEach(r => {
            r.addEventListener('change', () => {
              const cur = JSON.parse(localStorage.getItem(nsKey('savedAnswers')) || '{}');
              cur[`q${i}`] = r.value;
              localStorage.setItem(nsKey('savedAnswers'), JSON.stringify(cur));
              updateUnansweredCount();
            });
          });
        }
      });
      updateUnansweredCount();
      typeset(container);
    }

    function restoreAnswers() {
      const saved = JSON.parse(localStorage.getItem(nsKey('savedAnswers')) || '{}');
      for (const [key, value] of Object.entries(saved)) {
        const idx = Number(key.replace('q', ''));
        const q = questionData[idx] || {};
        if ((q.kieu_cau_hoi || '').toLowerCase() === 'tu_luan') {
          const ta = qs(`#${key}`);
          if (ta) ta.value = value;
        } else {
          const radio = qs(`#${key}_${value}`);
          if (radio) radio.checked = true;
        }
      }
    }

    function clearTempStorage() {
      localStorage.removeItem(nsKey('savedAnswers'));
      localStorage.removeItem(nsKey('savedTime'));
    }

    qs('#btn-submit')?.addEventListener('click', () => submitExam(false));

    async function submitExam(autoByTime) {
      clearInterval(timer);
      const name = qs('#hoten').value.trim();
      const made = qs('#made').value;
      currentMade = made;
      const sbd = qs('#sbd').value.trim();
      const dob = qs('#ngaysinh').value;
      let unanswered = 0;
      questionData.forEach((q, i) => {
        if (!getAnswerValue(i)) unanswered++;
      });
      if (!autoByTime && unanswered > 0) {
        if (!confirm(`B·∫°n c√≤n ${unanswered} c√¢u ch∆∞a tr·∫£ l·ªùi. B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i kh√¥ng?`)) {
          timer = setInterval(updateCountdown, 1000);
          return;
        }
      }
      const answers = [];
      let score = 0;
      questionData.forEach((q, i) => {
        const selected = getAnswerValue(i);
        const correctKey = q.dap_an_dung ? q.dap_an_dung.trim() : '';
        const kieu = (q.kieu_cau_hoi || 'trac_nghiem').toLowerCase();
        let selectedContent = '';
        let correctContent = '';
        if (kieu === 'trac_nghiem') {
          selectedContent = selected && q.lua_chon ? q.lua_chon[selected] : '(ch∆∞a ch·ªçn)';
          correctContent = correctKey && q.lua_chon ? q.lua_chon[correctKey] : '';
        } else {
          selectedContent = selected || '(ch∆∞a tr·∫£ l·ªùi)';
        }
        const isCorrect = (kieu === 'trac_nghiem') && selected && correctKey && selected.toUpperCase() === correctKey.toUpperCase();
        if (isCorrect) score++;
        answers.push({
          cau: i + 1,
          noi_dung: q.noi_dung,
          da_chon: processExamContent(selectedContent),
          dap_an_dung: processExamContent(correctContent),
          dung: !!isCorrect,
          kieu,
          goi_y_dap_an: q.goi_y_dap_an || ''
        });
      });
      const finalScore = questionData.length ? (score / questionData.length * 10).toFixed(2) : '0.00';
      clearTempStorage();
      const now = new Date();
      const formattedDate = now.toLocaleString('vi-VN', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' });
      let fileContent = `<div><strong>K·∫æT QU·∫¢ B√ÄI THI</strong></div>` +
        `<div>H·ªç t√™n: ${safeHTML(name)}</div>` +
        `<div>SBD: ${safeHTML(sbd)}</div>` +
        `<div>Ng√†y sinh: ${safeHTML(dob)}</div>` +
        `<div>M√£ ƒë·ªÅ: ${safeHTML(made)}</div>` +
        `<div>ƒêi·ªÉm: ${safeHTML(finalScore)}/10</div>` +
        `<div>N·ªôp l√∫c: ${safeHTML(formattedDate)}</div><br>`;
      answers.forEach(ans => {
        fileContent += `<div style="margin-bottom: .75rem;">C√¢u ${ans.cau}: <span>${safeHTML(ans.noi_dung)}</span></div>`;
        fileContent += `<div>B·∫°n ch·ªçn: <span>${safeHTML(ans.da_chon)}</span>`;
        if (ans.kieu === 'trac_nghiem') {
          fileContent += ` ${ans.dung ? '- ƒê√öNG' : '- SAI'}</div>`;
          if (ans.dap_an_dung) {
            fileContent += `<div>ƒê√°p √°n ƒë√∫ng: <span>${safeHTML(ans.dap_an_dung)}</span></div>`;
          }
        } else {
          fileContent += `</div>`;
          if (ans.goi_y_dap_an) {
            fileContent += `<div>G·ª£i √Ω ƒë√°p √°n: <span>${safeHTML(ans.goi_y_dap_an)}</span></div>`;
          }
        }
        fileContent += `<br>`;
      });
      const resultDiv = qs('#result-container');
      resultDiv.classList.remove('hidden');
      resultDiv.innerHTML = `
        <h1 class="text-2xl font-bold text-green-600 mb-4">‚úÖ K·∫æT QU·∫¢ B√ÄI THI</h1>
        <p class="text-sm text-gray-500 mb-4">üïí N·ªôp l√∫c: ${safeHTML(formattedDate)}</p>
        <div id="result-html" class="result-scrollable">${fileContent}</div>
        <div class="flex gap-4 mt-4">
          <button id="btn-download-doc" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">‚¨áÔ∏è T·∫£i k·∫øt qu·∫£ .DOC</button>
          <button id="btn-download-pdf" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">‚¨áÔ∏è T·∫£i k·∫øt qu·∫£ .PDF</button>
        </div>
      `;
      qs('#exam-container').classList.add('hidden');
      typeset(resultDiv);
      qs('#btn-download-doc')?.addEventListener('click', () => downloadDOC(name, made));
      qs('#btn-download-pdf')?.addEventListener('click', () => downloadPDF(name, made, answers, finalScore, formattedDate));
      try {
        await fetch(`${API_BASE}/save_result`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hoten: name, sbd, ngaysinh: dob, made, diem: finalScore, answers })
        });
      } catch (err) {
        console.error('L·ªói l∆∞u backend:', err);
      }
    }

    function downloadDOC(name, made) {
      const container = qs('#result-html');
      const header = `<!DOCTYPE html><html><head><meta charset='utf-8'><title>K·∫øt qu·∫£</title></head><body>`;
      const footer = '</body></html>';
      const blob = new Blob(['\ufeff', header + container.innerHTML + footer], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `KQ_${(name || '').replace(/\s+/g, '_')}_${made}.doc`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadPDF(name, made, answers, finalScore, formattedDate) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });
        let y = 40;
        const margin = 40;
        const pageHeight = doc.internal.pageSize.height;
        const maxWidth = 500;

        function addText(text, x, y, options = {}) {
          if (y > pageHeight - margin) {
            doc.addPage();
            y = 40;
          }
          doc.text(text, x, y, options);
          return y + (options.lineHeight || 20);
        }

        doc.setFont('helvetica', 'normal');
        doc.setFontSize(12);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        y = addText('K·∫æT QU·∫¢ B√ÄI THI', margin, y);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        y = addText(`H·ªç t√™n: ${name}`, margin, y);
        y = addText(`SBD: ${qs('#sbd').value}`, margin, y);
        y = addText(`Ng√†y sinh: ${qs('#ngaysinh').value}`, margin, y);
        y = addText(`M√£ ƒë·ªÅ: ${made}`, margin, y);
        y = addText(`ƒêi·ªÉm: ${finalScore}/10`, margin, y);
        y = addText(`N·ªôp l√∫c: ${formattedDate}`, margin, y);
        y += 10;

        answers.forEach(ans => {
          const cleanContent = ans.noi_dung.replace(/\\\(.*?\\\)/g, match => match.slice(2, -2));
          const cleanSelected = ans.da_chon.replace(/\\\(.*?\\\)/g, match => match.slice(2, -2));
          const cleanCorrect = ans.dap_an_dung.replace(/\\\(.*?\\\)/g, match => match.slice(2, -2));
          const cleanHint = ans.goi_y_dap_an.replace(/\\\(.*?\\\)/g, match => match.slice(2, -2));
          y = addText(`C√¢u ${ans.cau}: ${cleanContent}`, margin, y, { maxWidth });
          y = addText(`B·∫°n ch·ªçn: ${cleanSelected}${ans.kieu === 'trac_nghiem' ? (ans.dung ? ' - ƒê√öNG' : ' - SAI') : ''}`, margin, y, { maxWidth });
          if (ans.kieu === 'trac_nghiem' && ans.dap_an_dung) {
            y = addText(`ƒê√°p √°n ƒë√∫ng: ${cleanCorrect}`, margin, y, { maxWidth });
          }
          if (ans.goi_y_dap_an) {
            y = addText(`G·ª£i √Ω ƒë√°p √°n: ${cleanHint}`, margin, y, { maxWidth });
          }
          y += 10;
        });

        doc.save(`KQ_${(name || '').replace(/\s+/g, '_')}_${made}.pdf`);
      } catch (err) {
        console.error('L·ªói t·∫°o PDF:', err);
        alert('Kh√¥ng th·ªÉ t·∫°o t·ªáp PDF. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ki·ªÉm tra console ƒë·ªÉ bi·∫øt chi ti·∫øt!');
      }
    }

    // Kh·ªüi ƒë·ªông QR Scanner khi t·∫£i trang
    document.addEventListener('DOMContentLoaded', () => {
      startQrScanner();
    });
  </script>
</body>
</html>
