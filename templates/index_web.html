<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XUKA 4.0</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      background-image: url("https://raw.githubusercontent.com/Namhuy123789/xuka/main/h.png");
      background-size: cover;
      background-position: center;
      margin: 0;
      padding: 0;
    }
    .banner {
      background: linear-gradient(90deg, #4facfe, #00f2fe);
      color: #fff;
      padding: 20px;
      text-align: center;
      font-size: 25px;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
    }
    @keyframes marquee {
      0%   { transform: translateX(-100%); }
      100% { transform: translateX(100%);  }
    }
    .animate-marquee {
      display: inline-block;
      white-space: nowrap;
      animation: marquee 10s linear infinite;
    }
    .btn {
      display: inline-block;
      padding: 0.75rem 1.25rem;
      border-radius: 0.5rem;
      color: #fff;
      font-weight: 600;
      box-shadow: 0 1px 2px rgba(0,0,0,.1);
      transition: opacity .15s ease;
    }
    .btn:hover { opacity: 0.9; }
    .btn-blue   { background: #2563eb; }
    .btn-green  { background: #16a34a; }
    .btn-yellow { background: #eab308; color: #111; }
    .input-text {
      width: 100%; border: 1px solid #ccc; padding: .5rem .75rem; border-radius: .375rem;
    }
    .card {
      background: #fff; border-radius: .5rem; box-shadow: 0 1px 3px rgba(0,0,0,.1); padding: 1.5rem; margin-top: .5rem;
    }
    .max-w-md  { max-width: 28rem;  margin: 0 auto; }
    .max-w-xl  { max-width: 36rem;  margin: 0 auto; }
    .max-w-3xl { max-width: 48rem;  margin: 0 auto; }
    .result-scrollable {
      max-height: 400px;
      overflow-y: auto;
      padding: 1rem;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
    }
  </style>
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML,https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/extensions/mhchem.js" async></script>
</head>
<body>
  <!-- Banner -->
  <div class="banner">
    <h1>
      <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/xuka.ico" class="w-11 h-11 inline-block" alt="Xuka">
      <span class="text-3xl font-bold">XUKA 4.0</span>
      <span class="text-lg font-bold ml-2 text-yellow-300">xuka.com.vn</span><br>
      <span class="text-base font-semibold">PH·∫¶N M·ªÄM T·ªî CH·ª®C C√ÅC K·ª≤ THI - KI·ªÇM TRA</span>
    </h1>
  </div>

  <!-- Navbar -->
  <nav class="bg-yellow-300 py-1 shadow-md">
    <div class="flex items-center px-4 space-x-3">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/21/Flag_of_Vietnam.svg/1024px-Flag_of_Vietnam.svg.png"
           alt="VN Flag" class="h-6 w-8 rounded-sm shadow">
      <div class="w-[800px] h-8 flex items-center">
        <span class="text-blue-500 font-bold text-sm whitespace-nowrap">
          TR∆Ø·ªúNG THPT PH∆Ø·ªöC LONG - ƒê·ªíNG NAI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-white-700 text-lg">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
        </span>
      </div>
    </div>
  </nav>

  <!-- QR + 2 b√™n b√†i vi·∫øt hi·ªÉn th·ªã D·ªåC -->
  <div class="flex flex-col md:flex-row justify-center items-start gap-12 px-12 mt-8">
    <div id="left-column" class="flex flex-col gap-2 w-full md:w-1/4">
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <h2 class="text-xl font-bold text-blue-800 border-b pb-2 mb-3">üì∞ Tin m·ªõi t·ª´ VnExpress</h2>
        <ul class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <li>
            üåç<a href="https://vnexpress.net/the-gioi" target="_blank" class="text-blue-600 font-semibold hover:underline">
              Tin t·ª©c th·∫ø gi·ªõi
            </a><br>
            <span class="text-gray-500">T·ªïng h·ª£p nhanh nh·ªØng di·ªÖn bi·∫øn ch√≠nh tr·ªã, kinh t·∫ø, x√£ h·ªôi n·ªïi b·∫≠t tr√™n th·∫ø gi·ªõi.</span>
          </li>
        </ul>
      </div>
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <ul class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <li>
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/xuka.ico" alt="icon" class="inline w-4 h-4 mr-1">
            <a href="https://xuka.com.vn/huongdan" target="_blank" class="text-blue-600 font-semibold hover:underline">
              D√†nh cho qu·∫£ng c√°o
            </a><br>
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/bo.jpg" alt="icon" class="inline w-80 h-12 mr-1">
          </li>
        </ul>
      </div>
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <ul class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <li>
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/xuka.ico" alt="icon" class="inline w-4 h-4 mr-1">
            <a href="https://xuka.com.vn/huongdan" target="_blank" class="text-blue-600 font-semibold hover:underline">
              D√†nh cho qu·∫£ng c√°o
            </a><br>
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/k.jpg" alt="icon" class="inline w-80 h-12 mr-1">
          </li>
        </ul>
      </div>
    </div>

    <div id="main-column" class="flex flex-col gap-4 w-full max-w-md mx-auto">
      <div id="qr-login" class="bg-white p-6 rounded-xl shadow text-center">
        <h1 class="text-1xl font-bold text-pink-500 mb-4">QU√âT M√É QR</h1>
        <div id="reader" class="mx-auto" style="width: 90%; max-width: 300px;"></div>
        <p id="qr-error" class="text-red-600 mt-2 font-semibold hidden">QR kh√¥ng h·ª£p l·ªá!</p>
      </div>

      <div id="button-group" class="flex justify-center gap-3">
        <a href="/tronde" class="px-3 py-1.5 rounded-lg bg-gradient-to-b from-blue-500 to-blue-700 text-white font-semibold text-sm shadow-md shadow-blue-900/40 hover:shadow-lg hover:scale-105 active:scale-95 transition-transform duration-200 ease-out">
          Qu·∫£n tr·ªã
        </a>
        <a href="/xuka" class="px-3 py-1.5 rounded-lg bg-gradient-to-b from-green-400 to-green-600 text-white font-semibold text-sm shadow-md shadow-green-900/40 hover:shadow-lg hover:scale-105 active:scale-95 transition-transform duration-200 ease-out">
          ƒê√°nh gi√°
        </a>
        <a href="/alochat" class="px-3 py-1.5 rounded-lg bg-gradient-to-b from-green-400 to-green-600 text-white font-semibold text-sm shadow-md shadow-green-900/40 hover:shadow-lg hover:scale-105 active:scale-95 transition-transform duration-200 ease-out">
          Alo chat
        </a>
        <a href="/huongdan" class="px-3 py-1.5 rounded-lg bg-gradient-to-b from-yellow-400 to-yellow-600 text-white font-semibold text-sm shadow-md shadow-yellow-900/40 hover:shadow-lg hover:scale-105 active:scale-95 transition-transform duration-200 ease-out">
          H∆∞·ªõng d·∫´n
        </a>
      </div>
    </div>

    <div id="right-column" class="flex flex-col gap-2 w-full md:w-1/4">
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <h2 class="text-xl font-bold text-blue-800 border-b pb-2 mb-3">üì∞ S·ªû GD&ƒêT ƒê√îNG NAI</h2>
        <ul class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <li>
            üåç <a href="https://dnis.dongnai.gov.vn/" target="_blank" class="text-blue-600 font-semibold hover:underline">
              H·ªá th·ªëng vƒÉn b·∫£n
            </a><br>
            <span class="text-gray-500">H·ªá th·ªëng vƒÉn b·∫£n ch·ªâ ƒë·∫°o ƒëi·ªÅu h√†nh ng√†nh GD&ƒêT ƒê√¥ng Nai.</span>
          </li>
        </ul>
      </div>
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <ul class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <li>
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/xuka.ico" alt="icon" class="inline w-4 h-4 mr-1">
            <a href="https://xuka.com.vn/huongdan" target="_blank" class="text-blue-600 font-semibold hover:underline">
              D√†nh cho qu·∫£ng c√°o
            </a><br>
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/k.jpg" alt="icon" class="inline w-80 h-12 mr-1">
          </li>
        </ul>
      </div>
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <ul class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <li>
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/xuka.ico" alt="icon" class="inline w-4 h-4 mr-1">
            <a href="https://xuka.com.vn/huongdan" target="_blank" class="text-blue-600 font-semibold hover:underline">
              D√†nh cho qu·∫£ng c√°o
            </a><br>
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/bo.jpg" alt="icon" class="inline w-80 h-12 mr-1">
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Account Login -->
  <div id="account-login" class="max-w-md mx-auto bg-white p-6 rounded shadow hidden">
    <h1 class="text-2xl font-bold mb-4">ƒêƒÉng Nh·∫≠p T√†i Kho·∫£n</h1>
    <div class="mb-4">
      <label class="block font-semibold">T√™n ƒëƒÉng nh·∫≠p:</label>
      <input id="username" type="text" class="w-full border p-2" />
    </div>
    <div class="mb-4">
      <label class="block font-semibold">M·∫≠t kh·∫©u:</label>
      <input id="password" type="password" class="w-full border p-2" />
    </div>
    <button onclick="checkLogin()" class="bg-blue-600 text-white px-4 py-2 rounded">ƒêƒÉng nh·∫≠p</button>
    <p id="login-error" class="text-red-600 mt-2 font-semibold hidden">Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!</p>
  </div>

  <!-- Student Info -->
  <div id="login-form" class="max-w-xl mx-auto bg-white p-6 rounded shadow hidden">
    <h1 class="text-2xl font-bold mb-4">Th√¥ng Tin Th√≠ Sinh</h1>
    <div class="mb-4">
      <label class="block font-semibold">H·ªç v√† t√™n:</label>
      <input id="hoten" type="text" class="w-full border p-2" />
    </div>
    <div class="mb-4">
      <label class="block font-semibold">S·ªë b√°o danh:</label>
      <input id="sbd" type="text" class="w-full border p-2" />
    </div>
    <div class="mb-4">
      <label class="block font-semibold">Ng√†y sinh:</label>
      <input id="ngaysinh" type="date" class="w-full border p-2" />
    </div>
    <div class="mb-4">
      <label class="block font-semibold">M√£ ƒë·ªÅ:</label>
      <select id="made" class="w-full border p-2">
        <option value="">-- Ch·ªçn m√£ ƒë·ªÅ --</option>
      </select>
    </div>
    <button onclick="startExam()" class="bg-green-600 text-white px-4 py-2 rounded">B·∫Øt ƒë·∫ßu thi</button>
  </div>

  <!-- Exam -->
  <div id="exam-container" class="max-w-3xl mx-auto bg-white p-6 rounded shadow hidden">
    <h1 class="text-2xl font-bold mb-4 text-center">B√ÄI THI TR·∫ÆC NGHI·ªÜM</h1>
    <p id="countdown" class="text-red-600 font-bold mb-4">Th·ªùi gian: 60:00</p>
    <p id="unanswered-count" class="text-red-600 font-bold mb-4">C√¢u ch∆∞a tr·∫£ l·ªùi: 0</p>
    <div id="questions" class="space-y-4 mb-6"></div>
    <button onclick="submitExam()" class="bg-blue-600 text-white px-4 py-2 rounded">N·ªôp b√†i</button>
    <p id="result" class="mt-4 text-green-600 font-bold"></p>
  </div>

  <!-- Result -->
  <div id="result-container" class="max-w-3xl mx-auto p-6 bg-white rounded shadow mt-10 hidden"></div>

  <footer class="mt-10 py-4 text-center text-gray-700 text-sm font-medium rounded">
    B·∫£n quy·ªÅn ¬© 2025 <span class="font-bold text-red-600">PH·∫†M HUY TU√ÇN</span> ¬∑ ƒêT: <a href="tel:0389897989" class="text-blue-600 hover:underline">0389 897 989</a>
  </footer>
<script>
  const API_BASE = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1")
    ? "http://127.0.0.1:5000"
    : "https://xuka.com.vn";

  const MASTER_PASSPHRASE = "thay-bang-chuoi-bi-mat";
  const te = new TextEncoder();
  const td = new TextDecoder();

  let time = 3600; // 60 ph√∫t
  let timer;
  let questionData = [];

  function b64ToU8(b64) {
    return new Uint8Array([...atob(b64)].map(c => c.charCodeAt(0)));
  }

  async function deriveAesKey(passphrase, salt) {
    const keyMaterial = await crypto.subtle.importKey(
      'raw',
      te.encode(passphrase),
      { name: 'PBKDF2' },
      false,
      ['deriveKey']
    );
    return crypto.subtle.deriveKey(
      { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
      keyMaterial,
      { name: 'AES-GCM', length: 256 },
      false,
      ['encrypt', 'decrypt']
    );
  }

  async function decryptWithPassphrase(qrText, passphrase) {
    const parts = qrText.split(".");
    if (parts.length !== 4 || parts[0] !== "v1") throw new Error("QR kh√¥ng h·ª£p l·ªá!");
    const salt = b64ToU8(parts[1]);
    const iv = b64ToU8(parts[2]);
    const cipher = b64ToU8(parts[3]);
    const key = await deriveAesKey(passphrase, salt);
    const plainBuf = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, cipher);
    return td.decode(plainBuf);
  }

  for (let i = 101; i <= 124; i++) {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = i;
    document.getElementById("made").appendChild(opt);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const qrScanner = new Html5Qrcode("reader");
    qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decoded) => {
      decryptWithPassphrase(decoded, MASTER_PASSPHRASE)
        .then(() => {
          qrScanner.stop().then(() => {
            document.getElementById('qr-login').classList.add('hidden');
            document.getElementById('button-group').classList.add('hidden');
            document.getElementById('left-column').classList.add('hidden');
            document.getElementById('right-column').classList.add('hidden');
            document.getElementById('account-login').classList.remove('hidden');
          }).catch(err => console.error("L·ªói khi d·ª´ng QR Scanner:", err));
        })
        .catch(() => {
          document.getElementById('qr-error').classList.remove('hidden');
        });
    }, (error) => {
      console.error("L·ªói qu√©t QR:", error);
      document.getElementById('qr-error').classList.remove('hidden');
    });
  });

  function checkLogin() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    // Gi·∫£ l·∫≠p ƒëƒÉng nh·∫≠p th√†nh c√¥ng cho th·ª≠ nghi·ªám c·ª•c b·ªô
    document.getElementById('account-login').classList.add('hidden');
    document.getElementById('login-form').classList.remove('hidden');
  }

  function updateCountdown() {
    const m = Math.floor(time / 60).toString().padStart(2, '0');
    const s = (time % 60).toString().padStart(2, '0');
    document.getElementById("countdown").innerText = `Th·ªùi gian: ${m}:${s}`;
    if (time <= 0) {
      clearInterval(timer);
      let unanswered = 0;
      questionData.forEach((q, i) => {
        const selected = getAnswerValue(i);
        if (!selected) unanswered++;
      });
      if (unanswered > 0) {
        if (confirm(`Th·ªùi gian ƒë√£ h·∫øt! B·∫°n c√≤n ${unanswered} c√¢u ch∆∞a tr·∫£ l·ªùi. B·∫°n c√≥ mu·ªën n·ªôp b√†i kh√¥ng?`)) {
          submitExam();
        } else {
          alert("Vui l√≤ng ho√†n th√†nh c√°c c√¢u h·ªèi c√≤n l·∫°i!");
          time = 300; // Gia h·∫°n th√™m 5 ph√∫t
          timer = setInterval(updateCountdown, 1000);
        }
      } else {
        submitExam();
      }
    }
    time--;
    localStorage.setItem("savedTime", time);
  }

  function processExamContent(content) {
    let s = String(content || "");
    
    // X·ª≠ l√Ω c√°c k√Ω t·ª± to√°n h·ªçc c∆° b·∫£n
    s = s.replace(/\blog(\d+)\(([^)]+)\)/gi, (_, base, arg) => `\\log_{${base}}(${arg.trim()})`);
    s = s.replace(/\blog\(([^)]+)\)/gi, (_, arg) => `\\log(${arg.trim()})`);
    s = s.replace(/ln\(([^)]+)\)/gi, (_, arg) => `\\ln(${arg.trim()})`);
    s = s.replace(/frac\(([^,]+),([^)]+)\)/gi, (_, a, b) => `\\frac{${a.trim()}}{${b.trim()}}`);
    s = s.replace(/\b([A-Za-z0-9]+)\/([A-Za-z0-9]+)\b/g, (_, a, b) => `\\frac{${a}}{${b}}`);
    s = s.replace(/sqrt\[(\d+)\]\(([^)]+)\)/gi, (_, n, val) => `\\sqrt[${n}]{${val.trim()}}`);
    s = s.replace(/sqrt\(([^)]+)\)/gi, (_, val) => `\\sqrt{${val.trim()}}`);
    s = s.replace(/([A-Za-z])_(\d+)/g, (_, base, sub) => `${base}_{${sub}}`);
    s = s.replace(/([A-Za-z0-9])\^(\d+)/g, (_, base, sup) => `${base}^{${sup}}`);
    
    // X·ª≠ l√Ω c√°c k√Ω hi·ªáu to√°n h·ªçc n√¢ng cao
    s = s.replace(/int_([^_]+)(?:_([^_]+))?([^]*?)(?=\s|$)/gi, (_, from, to, body) => 
      `\\int${from ? `_{${from}}` : ''}${to ? `^{${to}}` : ''}${body.trim()}`);
    s = s.replace(/sum_([^_]+)(?:_([^_]+))?([^]*?)(?=\s|$)/gi, (_, from, to, body) => 
      `\\sum${from ? `_{${from}}` : ''}${to ? `^{${to}}` : ''}${body.trim()}`);
    s = s.replace(/lim_([^_]+)([^]*?)(?=\s|$)/gi, (_, limit, body) => `\\lim_{${limit}}${body.trim()}`);
    s = s.replace(/d\/dx\(([^)]+)\)/gi, (_, expr) => `\\frac{d}{dx}(${expr.trim()})`);
    s = s.replace(/vec\{(\w+)\}/gi, (_, varName) => `\\vec{${varName}}`);
    s = s.replace(/\|vec\{(\w+)\}\|/gi, (_, varName) => `|\\vec{${varName}}|`);
    
    // X·ª≠ l√Ω k√Ω hi·ªáu v·∫≠t l√Ω v√† h√≥a h·ªçc
    s = s.replace(/Delta/g, '\\Delta');
    s = s.replace(/nabla/g, '\\nabla');
    s = s.replace(/(\w+)_(\w+)/g, (_, base, sub) => `${base}_{${sub}}`);
    s = s.replace(/(\w+)\^(\w+)/g, (_, base, sup) => `${base}^{${sup}}`);
    s = s.replace(/H_2O/g, '\\ce{H2O}');
    s = s.replace(/CO_2/g, '\\ce{CO2}');
    s = s.replace(/([A-Z][a-z]?)_(\d+)/g, (_, elem, num) => `\\ce{${elem}${num}}`);
    
    // ƒê·∫£m b·∫£o b·ªçc c√°c bi·ªÉu th·ª©c to√°n h·ªçc trong \( ... \)
    function isInsideMath(str, offset) {
      const upto = str.slice(0, offset);
      const lastOpen = upto.lastIndexOf('\\(');
      const lastClose = upto.lastIndexOf('\\)');
      return lastOpen > lastClose;
    }

    const patterns = [
      /\\frac\{[^}]+\}\{[^}]+\}/g,
      /\\sqrt(?:\[[^\]]+\])?\{[^}]+\}/g,
      /\\log_\{\d+\}\([^)]*\)/g,
      /\b(?:log\d*|log|ln|sin|cos|tan|exp|int|sum|lim|d\/dx|vec)\([^)]*\)/gi,
      /[A-Za-z0-9]+_\{\d+\}/g,
      /[A-Za-z0-9]\^\{\d+\}/g,
      /\\ce\{[^}]+\}/g,
      /\\Delta/g,
      /\\nabla/g
    ];

    patterns.forEach(pattern => {
      s = s.replace(pattern, function(match, ...args) {
        const offset = args[args.length - 2];
        const str = args[args.length - 1];
        if (isInsideMath(str, offset)) return match;
        if (/^\\\(.*\\\)$/.test(match)) return match;
        const beforeChar = offset > 0 ? str[offset - 1] : '';
        const afterChar = str[offset + match.length] || '';
        const needPreSpace = beforeChar && !/[\s\(\[{,;:!?\-]/.test(beforeChar);
        const needPostSpace = afterChar && !/[\s\)\]\},;:!?.]/.test(afterChar);
        const pre = needPreSpace ? ' ' : '';
        const post = needPostSpace ? ' ' : '';
        return pre + `\\(${match}\\)` + post;
      });
    });

    return s;
  }

  function processAllQuestions(questions) {
    return questions.map(q => {
      q.noi_dung = processExamContent(q.noi_dung);
      if (q.lua_chon && typeof q.lua_chon === 'object') {
        for (let key in q.lua_chon) {
          if (q.lua_chon.hasOwnProperty(key)) {
            q.lua_chon[key] = processExamContent(q.lua_chon[key]);
          }
        }
      }
      q.dap_an_dung = q.dap_an_dung ? q.dap_an_dung : "";
      q.goi_y_dap_an = q.goi_y_dap_an ? processExamContent(q.goi_y_dap_an) : "";
      return q;
    });
  }

  function getAnswerValue(index) {
    const q = questionData[index];
    if (q.kieu_cau_hoi === "tu_luan") {
      const textarea = document.getElementById(`q${index}`);
      return textarea ? textarea.value.trim() : "";
    } else {
      const radios = document.getElementsByName(`q${index}`);
      for (const radio of radios) {
        if (radio.checked) {
          return radio.value;
        }
      }
      return "";
    }
  }

  function renderQuestions(questions) {
    const container = document.getElementById("questions");
    container.innerHTML = "";
    
    const unansweredLabel = document.createElement("p");
    unansweredLabel.id = "unanswered-count";
    unansweredLabel.classList.add("text-red-600", "font-bold", "mb-4");
    container.appendChild(unansweredLabel);

    questions.forEach((q, i) => {
      const div = document.createElement('div');
      div.classList.add("mb-6", "p-4", "bg-gray-50", "rounded-lg");
      div.innerHTML = `
        <label class="block font-semibold mb-2 text-lg">
          C√¢u ${i + 1}: ${q.noi_dung}
        </label>
      `;
      if (q.kieu_cau_hoi === "tu_luan") {
        div.innerHTML += `
          <textarea id="q${i}" rows="4" 
            class="border p-2 w-full rounded-md" 
            placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..."></textarea>
        `;
      } else if (q.lua_chon) {
        const optionsHtml = Object.entries(q.lua_chon).map(([k, v]) => {
          return `
            <div class="flex items-start space-x-2 min-w-max">
              <input type="radio" name="q${i}" id="q${i}_${k}" value="${k}" class="mt-1">
              <label for="q${i}_${k}" class="overflow-x-auto block" style="max-width: calc(100% - 30px);">
                ${k}. ${v}
              </label>
            </div>
          `;
        }).join("");
        div.innerHTML += `
          <div class="border rounded-md p-2 max-h-40 overflow-y-auto space-y-2">
            ${optionsHtml}
          </div>
        `;
      }
      container.appendChild(div);
    });

    function updateUnansweredCount() {
      let unanswered = 0;
      questions.forEach((q, i) => {
        const selected = getAnswerValue(i);
        if (!selected) unanswered++;
      });
      unansweredLabel.innerText = `C√¢u ch∆∞a tr·∫£ l·ªùi: ${unanswered}`;
    }

    questions.forEach((q, i) => {
      if (q.kieu_cau_hoi === "tu_luan") {
        const textarea = document.getElementById(`q${i}`);
        if (textarea) {
          textarea.addEventListener("input", () => {
            const current = JSON.parse(localStorage.getItem("savedAnswers") || "{}");
            current[`q${i}`] = textarea.value;
            localStorage.setItem("savedAnswers", JSON.stringify(current));
            updateUnansweredCount();
          });
        }
      } else {
        const radios = document.getElementsByName(`q${i}`);
        radios.forEach(radio => {
          radio.addEventListener("change", () => {
            const current = JSON.parse(localStorage.getItem("savedAnswers") || "{}");
            current[`q${i}`] = radio.value;
            localStorage.setItem("savedAnswers", JSON.stringify(current));
            updateUnansweredCount();
          });
        });
      }
    });

    updateUnansweredCount();
    if (typeof MathJax !== 'undefined') {
      MathJax.Hub.Queue(["Typeset", MathJax.Hub, container]);
    }
  }

  function startExam() {
    const name = document.getElementById('hoten').value.trim();
    const sbd = document.getElementById('sbd').value.trim();
    const dob = document.getElementById("ngaysinh").value;
    const made = document.getElementById('made').value;

    if (!name || !sbd || !dob || !made) {
      return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß H·ªç t√™n, SBD, Ng√†y sinh v√† M√£ ƒë·ªÅ!");
    }

    document.getElementById("login-form").classList.add("hidden");
    document.getElementById("exam-container").classList.remove("hidden");

    const savedTime = localStorage.getItem("savedTime");
    time = savedTime ? parseInt(savedTime) : 3600; // 60 ph√∫t
    timer = setInterval(updateCountdown, 1000);

    const jsonFile = `/questions/questions${made}.json`;
    fetch(jsonFile, {
      headers: { 'Accept': 'application/json' }
    })
      .then(res => {
        if (!res.ok) {
          throw new Error(`Kh√¥ng th·ªÉ t·∫£i file c√¢u h·ªèi: ${res.status} ${res.statusText} (File: ${jsonFile})`);
        }
        return res.json();
      })
      .then(data => {
        if (!Array.isArray(data)) {
          throw new Error("D·ªØ li·ªáu c√¢u h·ªèi kh√¥ng ph·∫£i l√† m·∫£ng");
        }
        questionData = processAllQuestions(data);
        renderQuestions(questionData);
        restoreAnswers();
      })
      .catch(err => {
        console.error("L·ªói chi ti·∫øt:", err);
        alert(`Kh√¥ng th·ªÉ t·∫£i file c√¢u h·ªèi: ${err.message}. Vui l√≤ng ki·ªÉm tra file ${jsonFile} v√† server Flask.`);
      });
  }

  function restoreAnswers() {
    const saved = JSON.parse(localStorage.getItem("savedAnswers") || "{}");
    for (const [key, value] of Object.entries(saved)) {
      const index = parseInt(key.replace('q', ''));
      const q = questionData[index];
      if (q.kieu_cau_hoi === "tu_luan") {
        const textarea = document.getElementById(key);
        if (textarea) {
          textarea.value = value;
        }
      } else {
        const radio = document.getElementById(`${key}_${value}`);
        if (radio) {
          radio.checked = true;
        }
      }
    }
  }

  function clearTempStorage() {
    localStorage.removeItem("savedAnswers");
    localStorage.removeItem("hoten");
    localStorage.removeItem("made");
    localStorage.removeItem("savedTime");
  }

  function submitExam() {
    let unanswered = 0;
    questionData.forEach((q, i) => {
      const selected = getAnswerValue(i);
      if (!selected) unanswered++;
    });

    if (unanswered > 0) {
      if (!confirm(`B·∫°n c√≤n ${unanswered} c√¢u ch∆∞a tr·∫£ l·ªùi. B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i kh√¥ng?`)) {
        return;
      }
    }

    clearInterval(timer);
    const name = document.getElementById('hoten').value.trim();
    const made = document.getElementById('made').value;
    const sbd = document.getElementById('sbd').value.trim();
    const dob = document.getElementById("ngaysinh").value;

    const answers = [];
    let score = 0;

    questionData.forEach((q, i) => {
      const selected = getAnswerValue(i);
      const correctKey = q.dap_an_dung ? q.dap_an_dung.trim() : "";
      const kieu = q.kieu_cau_hoi ? q.kieu_cau_hoi.toLowerCase() : "trac_nghiem";

      let selectedContent = "";
      let correctContent = "";

      if (kieu === "trac_nghiem") {
        selectedContent = selected && q.lua_chon ? q.lua_chon[selected] : "(ch∆∞a ch·ªçn)";
        correctContent = correctKey && q.lua_chon ? q.lua_chon[correctKey] : "";
      } else {
        selectedContent = selected || "(ch∆∞a tr·∫£ l·ªùi)";
        correctContent = "";
      }

      const isCorrect =
        kieu === "trac_nghiem" &&
        selected.toUpperCase() === correctKey.toUpperCase();

      if (isCorrect) {
        score++;
      }

      answers.push({
        cau: i + 1,
        noi_dung: q.noi_dung,
        da_chon: processExamContent(selectedContent),
        dap_an_dung: processExamContent(correctContent),
        dung: isCorrect,
        kieu: kieu,
        goi_y_dap_an: q.goi_y_dap_an || ""
      });
    });

    const finalScore = (score / questionData.length * 10).toFixed(2);

    clearTempStorage();
    const now = new Date();
    const formattedDate = now.toLocaleString("vi-VN", {
      hour12: false,
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      day: "2-digit",
      month: "2-digit",
      year: "numeric"
    });

    let fileContent = `<div>K·∫æT QU·∫¢ B√ÄI THI</div>`;
    fileContent += `<div>H·ªç t√™n: ${name}</div>`;
    fileContent += `<div>SBD: ${sbd}</div>`;
    fileContent += `<div>Ng√†y sinh: ${dob}</div>`;
    fileContent += `<div>M√£ ƒë·ªÅ: ${made}</div>`;
    fileContent += `<div>ƒêi·ªÉm: ${finalScore}/10</div>`;
    fileContent += `<div>N·ªôp l√∫c: ${formattedDate}</div><br>`;

    answers.forEach(ans => {
      fileContent += `<div style="margin-bottom: 1rem;">C√¢u ${ans.cau}: <span>${ans.noi_dung}</span></div>`;
      fileContent += `<div>B·∫°n ch·ªçn: <span>${ans.da_chon}</span>`;
      if (ans.kieu === "trac_nghiem") {
        fileContent += ` ${ans.dung ? "- ƒê√öNG" : "- SAI"}</div>`;
        if (ans.dap_an_dung) {
          fileContent += `<div>ƒê√°p √°n ƒë√∫ng: <span>${ans.dap_an_dung}</span></div>`;
        }
      } else {
        fileContent += `</div>`;
        if (ans.goi_y_dap_an) {
          fileContent += `<div>G·ª£i √Ω ƒë√°p √°n: <span>${ans.goi_y_dap_an}</span></div>`;
        }
      }
      fileContent += `<br>`;
    });

    const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' 
    xmlns:w='urn:schemas-microsoft-com:office:word' 
    xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'>
    <title>K·∫øt qu·∫£</title></head><body>`;
    const footer = "</body></html>";
    const wordContent = header + fileContent + footer;
    const blob = new Blob(['\ufeff', wordContent], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const fileName = `KQ_${name.replace(/\s+/g, "_")}_${made}.doc`;

    const resultDiv = document.getElementById("result-container");
    resultDiv.classList.remove("hidden");
    resultDiv.innerHTML = `
      <h1 class="text-2xl font-bold text-green-600 mb-4">‚úÖ K·∫æT QU·∫¢ B√ÄI THI !</h1>
      <p class="text-sm text-gray-500 mb-4">üïí N·ªôp l√∫c: ${formattedDate}</p>
      <div class="result-scrollable">${fileContent}</div>
      <div class="flex gap-4 mt-4">
        <a href="${url}" download="${fileName}" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
          ‚¨áÔ∏è T·∫£i k·∫øt qu·∫£ .Doc
        </a>
        <button onclick="downloadPDF()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
          ‚¨áÔ∏è T·∫£i k·∫øt qu·∫£ .PDF
        </button>
      </div>
    `;
    document.getElementById("exam-container").classList.add("hidden");

    if (typeof MathJax !== 'undefined') {
      MathJax.Hub.Queue(["Typeset", MathJax.Hub, resultDiv]);
    } else {
      console.error("MathJax is not loaded!");
    }

    fetch(`${API_BASE}/save_result`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        hoten: name,
        sbd: sbd,
        ngaysinh: dob,
        made: made,
        diem: finalScore,
        answers: answers
      })
    })
      .then(res => res.json())
      .then(data => {
        console.log("K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o backend:", data);
      })
      .catch(err => {
        console.error("L·ªói khi l∆∞u k·∫øt qu·∫£ v√†o backend:", err);
      });
  }

  function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const resultDiv = document.getElementById("result-container").innerText;
    doc.text(resultDiv, 10, 10);
    doc.save(`KQ_${document.getElementById('hoten').value.replace(/\s+/g, "_")}_${document.getElementById('made').value}.pdf`);
  }
</script>
</body>
</html>
