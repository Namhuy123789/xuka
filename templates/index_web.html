<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XUKA 4.0</title>
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Html5Qrcode -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- MathJax -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML,https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/extensions/mhchem.js" async></script>
  <style>
    body {
      background-image: url("https://raw.githubusercontent.com/Namhuy123789/xuka/main/h.png");
      background-size: cover;
      background-position: center;
      margin: 0;
      padding: 0;
    }
    .banner {
      background: linear-gradient(90deg, #4facfe, #00f2fe);
      color: #fff;
      padding: 20px;
      text-align: center;
      font-size: 25px;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
    }
    @keyframes marquee {
      0%   { transform: translateX(-100%); }
      100% { transform: translateX(100%);  }
    }
    .animate-marquee {
      display: inline-block;
      white-space: nowrap;
      animation: marquee 10s linear infinite;
    }
    /* N√∫t ti·ªán d√πng */
    .btn {
      display: inline-block;
      padding: 0.75rem 1.25rem;
      border-radius: 0.5rem;
      color: #fff;
      font-weight: 600;
      box-shadow: 0 1px 2px rgba(0,0,0,.1);
      transition: opacity .15s ease;
    }
    .btn:hover { opacity: 0.9; }
    .btn-blue   { background: #2563eb; }
    .btn-green  { background: #16a34a; }
    .btn-yellow { background: #eab308; color: #111; }
    .input-text {
      width: 100%; border: 1px solid #ccc; padding: .5rem .75rem; border-radius: .375rem;
    }
    .card {
      background: #fff; border-radius: .5rem; box-shadow: 0 1px 3px rgba(0,0,0,.1); padding: 1.5rem; margin-top: .5rem;
    }
    .max-w-md  { max-width: 28rem;  margin: 0 auto; }
    .max-w-xl  { max-width: 36rem;  margin: 0 auto; }
    .max-w-3xl { max-width: 48rem;  margin: 0 auto; }
    .hidden {
      display: none !important;
    }
  </style>
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
</head>
<body>
  <!-- Banner -->
  <div class="banner">
    <h1>
      <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/xuka.ico" class="w-11 h-11 inline-block" alt="Xuka">
      <span class="text-3xl font-bold">XUKA 4.0</span>
      <span class="text-lg font-bold ml-2 text-yellow-300">xuka.com.vn</span><br>
      <span class="text-base font-semibold">PH·∫¶N M·ªÄM T·ªî CH·ª®C C√ÅC K·ª≤ THI - KI·ªÇM TRA</span>
    </h1>
  </div>

  <!-- Navbar -->
  <nav class="bg-yellow-300 py-1 shadow-md">
    <div class="flex items-center px-4 space-x-3">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/21/Flag_of_Vietnam.svg/1024px-Flag_of_Vietnam.svg.png"
           alt="VN Flag" class="h-6 w-8 rounded-sm shadow">
      <div class="w-[800px] h-8 flex items-center">
        <span class="text-blue-500 font-bold text-sm whitespace-nowrap">
          TR∆Ø·ªúNG THPT PH∆Ø·ªöC LONG - ƒê·ªíNG NAI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-white-700 text-lg">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
        </span>
      </div>
    </div>
  </nav>

  <!-- QR + 2 b√™n b√†i vi·∫øt hi·ªÉn th·ªã D·ªåC -->
  <div class="flex flex-col md:flex-row justify-center items-start gap-12 px-12 mt-1">
    <!-- C·ªôt tr√°i: 2 kh·ªëi tin t·ª©c x·∫øp d·ªçc -->
    <div id="left-column" class="flex flex-col gap-2 w-full md:w-1/4">
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <h2 class="text-xl font-bold text-blue-800 border-b pb-2 mb-3">
          
          üì∞ Tin m·ªõi t·ª´ VnExpress
        </h2>
        <ul class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <li>
            üåç<a href="https://vnexpress.net/the-gioi" target="_blank" class="text-blue-600 font-semibold hover:underline">
              Tin t·ª©c th·∫ø gi·ªõi
            </a><br>
            <span class="text-gray-500">T·ªïng h·ª£p nhanh nh·ªØng di·ªÖn bi·∫øn ch√≠nh tr·ªã, kinh t·∫ø, x√£ h·ªôi n·ªïi b·∫≠t tr√™n th·∫ø gi·ªõi.</span>
          </li>
        </ul>
      </div>
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <ul class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <li>
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/xuka.ico" alt="icon" class="inline w-4 h-4 mr-1">
            <a href="https://xuka.com.vn/huongdan" target="_blank" class="text-blue-600 font-semibold hover:underline">
              D√†nh cho qu·∫£ng c√°o
            </a><br>
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/bo.jpg" alt="icon" class="inline w-80 h-12 mr-1">
          </li>
        </ul>
      </div>
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <ul class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <li>
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/xuka.ico" alt="icon" class="inline w-4 h-4 mr-1">
            <a href="https://xuka.com.vn/huongdan" target="_blank" class="text-blue-600 font-semibold hover:underline">
              D√†nh cho qu·∫£ng c√°o
            </a><br>
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/k.jpg" alt="icon" class="inline w-80 h-12 mr-1">
          </li>
        </ul>
      </div>
    </div>

    <!-- C·ªôt gi·ªØa: QR Login v√† nh√≥m n√∫t x·∫øp ngang -->
    <div id="main-column" class="flex flex-col gap-4 w-full max-w-md mt-1">
      <!-- QR Login -->
      <div id="qr-login" class="bg-white p-6 rounded-xl shadow text-center">
        <h1 class="text-1xl font-bold text-pink-500 mb-4">QU√âT M√É QR</h1>
        <div id="reader" class="mx-auto" style="width: 90%; max-width: 300px;"></div>
        <p id="qr-error" class="text-red-600 mt-2 font-semibold hidden">QR kh√¥ng h·ª£p l·ªá!</p>
        <!-- Input file cho upload QR -->
        <input type="file" id="qr-file" accept="image/*" style="display: none;">
        <!-- Nh√≥m n√∫t n·∫±m ngang -->
        <div class="flex justify-center gap-4 mt-4">
          <button id="flip-camera" 
            class="flex items-center justify-center gap-2 px-4 py-2 rounded-xl text-white font-semibold
                   bg-gradient-to-r from-green-400 via-teal-500 to-blue-500
                   shadow-lg transform transition-all duration-200
                   hover:scale-105 hover:shadow-2xl active:scale-95 active:shadow-inner">
            <span class="border-2 border-white rounded-full p-1 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6M20 20v-6h-6M4 14a8 8 0 0116 0 8 8 0 01-16 0z"/>
              </svg>
            </span>
          </button>
          <button id="upload-qr" 
            class="flex items-center justify-center gap-2 px-4 py-2 rounded-xl text-white font-semibold
                   bg-gradient-to-r from-green-400 via-teal-500 to-blue-500
                   shadow-lg transform transition-all duration-200
                   hover:scale-105 hover:shadow-2xl active:scale-95 active:shadow-inner">
            <span class="border-2 border-white rounded-full p-1 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 7h4l3-3h4l3 3h4v14H3V7z" />
                <circle cx="12" cy="13" r="4" stroke="white" stroke-width="2" />
              </svg>
            </span>
          </button>
          <button id="stop-camera" 
            class="flex items-center justify-center gap-2 px-4 py-2 rounded-xl text-white font-semibold
                   bg-gradient-to-r from-red-400 to-red-600
                   shadow-lg transform transition-all duration-200
                   hover:scale-105 hover:shadow-2xl active:scale-95 active:shadow-inner">
            <span class="border-2 border-white rounded-full p-1 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </span>
          </button>
        </div>
      </div>
      <!-- Nh√≥m 3 n√∫t n·∫±m ngang nh·ªè -->
      <div id="button-group" class="flex justify-center gap-3">
        <a href="/tronde" 
           class="px-3 py-1.5 rounded-lg bg-gradient-to-b from-blue-500 to-blue-700 text-white font-semibold text-sm
                  shadow-md shadow-blue-900/40 
                  hover:shadow-lg hover:scale-105 
                  active:scale-95 
                  transition-transform duration-200 ease-out">
          Qu·∫£n tr·ªã
        </a>
        <a href="/xuka" 
           class="px-3 py-1.5 rounded-lg bg-gradient-to-b from-green-400 to-green-600 text-white font-semibold text-sm 
                  shadow-md shadow-green-900/40 
                  hover:shadow-lg hover:scale-105 
                  active:scale-95 
                  transition-transform duration-200 ease-out">
          ƒê√°nh gi√°
        </a>
        <a href="/alochat" 
           class="px-3 py-1.5 rounded-lg bg-gradient-to-b from-green-400 to-green-600 text-white font-semibold text-sm 
                  shadow-md shadow-green-900/40 
                  hover:shadow-lg hover:scale-105 
                  active:scale-95 
                  transition-transform duration-200 ease-out">
          Alo chat
        </a>
        <a href="/huongdan" 
           class="px-3 py-1.5 rounded-lg bg-gradient-to-b from-yellow-400 to-yellow-600 text-white font-semibold text-sm 
                  shadow-md shadow-yellow-900/40 
                  hover:shadow-lg hover:scale-105 
                  active:scale-95 
                  transition-transform duration-200 ease-out">
          H∆∞·ªõng d·∫´n
        </a>
      </div>
    </div>

    <!-- C·ªôt ph·∫£i: 2 kh·ªëi th√¥ng b√°o x·∫øp d·ªçc -->
    <div id="right-column" class="flex flex-col gap-2 w-full md:w-1/4">
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <h2 class="text-xl font-bold text-blue-800 border-b pb-2 mb-3">üì∞ S·ªû GD&ƒêT ƒê√îNG NAI</h2>
        <ul class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <li>
            üåç <a href="https://dnis.dongnai.gov.vn/" target="_blank" class="text-blue-600 font-semibold hover:underline">
              H·ªá th·ªëng vƒÉn b·∫£n
            </a><br>
            <span class="text-gray-500">H·ªá th·ªëng vƒÉn b·∫£n ch·ªâ ƒë·∫°o ƒëi·ªÅu h√†nh ng√†nh GD&ƒêT ƒê√¥ng Nai.</span>
          </li>
        </ul>
      </div>
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <ul class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <li>
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/xuka.ico" alt="icon" class="inline w-4 h-4 mr-1">
            <a href="https://xuka.com.vn/huongdan" target="_blank" class="text-blue-600 font-semibold hover:underline">
              D√†nh cho qu·∫£ng c√°o
            </a><br>
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/k.jpg" alt="icon" class="inline w-80 h-12 mr-1">
          </li>
        </ul>
      </div>
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <ul class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <li>
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/xuka.ico" alt="icon" class="inline w-4 h-4 mr-1">
            <a href="https://xuka.com.vn/huongdan" target="_blank" class="text-blue-600 font-semibold hover:underline">
              D√†nh cho qu·∫£ng c√°o
            </a><br>
            <img src="https://raw.githubusercontent.com/Namhuy123789/xuka/main/bo.jpg" alt="icon" class="inline w-80 h-12 mr-1">
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Account Login -->
  <div id="account-login" class="max-w-md mx-auto bg-white p-6 rounded shadow hidden">
    <h1 class="text-2xl font-bold mb-4">ƒêƒÉng Nh·∫≠p T√†i Kho·∫£n</h1>
    <form id="account-login-form">
      <div class="mb-4">
        <label class="block font-semibold">T√™n ƒëƒÉng nh·∫≠p:</label>
        <input id="username" type="text" class="w-full border p-2" />
      </div>
      <div class="mb-4">
        <label class="block font-semibold">M·∫≠t kh·∫©u:</label>
        <input id="password" type="password" class="w-full border p-2" />
      </div>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">ƒêƒÉng nh·∫≠p</button>
      <p id="login-error" class="text-red-600 mt-2 font-semibold hidden">Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!</p>
    </form>
  </div>

  <!-- Student Info -->
  <div id="login-form" class="max-w-xl mx-auto bg-white p-6 rounded shadow hidden">
    <h1 class="text-2xl font-bold mb-4">Th√¥ng Tin Th√≠ Sinh</h1>
    <div class="mb-4">
      <label class="block font-semibold">H·ªç v√† t√™n:</label>
      <input id="hoten" type="text" class="w-full border p-2" />
    </div>
    <div class="mb-4">
      <label class="block font-semibold">S·ªë b√°o danh:</label>
      <input id="sbd" type="text" class="w-full border p-2" />
    </div>
    <div class="mb-4">
      <label class="block font-semibold">Ng√†y sinh:</label>
      <input id="ngaysinh" type="date" class="w-full border p-2" />
    </div>
    <div class="mb-4">
      <label class="block font-semibold">M√£ ƒë·ªÅ:</label>
      <select id="made" class="w-full border p-2">
        <option value="">-- Ch·ªçn m√£ ƒë·ªÅ --</option>
      </select>
    </div>
    <button onclick="startExam()" class="bg-green-600 text-white px-4 py-2 rounded">B·∫Øt ƒë·∫ßu thi</button>
  </div>

  <!-- Exam -->
  <div id="exam-container" class="max-w-3xl mx-auto bg-white p-6 rounded shadow hidden">
    <h1 class="text-2xl font-bold mb-4 text-center">B√ÄI THI TR·∫ÆC NGHI·ªÜM</h1>
    <p id="countdown" class="text-red-600 font-bold mb-4">Th·ªùi gian: 60:00</p>
    <div id="questions" class="space-y-4 mb-6"></div>
    <button onclick="submitExam()" class="bg-blue-600 text-white px-4 py-2 rounded">N·ªôp b√†i</button>
    <p id="result" class="mt-4 text-green-600 font-bold"></p>
  </div>

  <!-- Result -->
  <div id="result-container" class="max-w-2xl mx-auto p-6 bg-white rounded shadow mt-10 hidden"></div>
  
  <footer class="mt-10 py-4 text-center text-gray-700 text-sm font-medium rounded">
    B·∫£n quy·ªÅn ¬© 2025 <span class="font-bold text-red-600">PH·∫†M HUY TU√ÇN</span> ¬∑ ƒêT: <a href="tel:0389897989" class="text-blue-600 hover:underline">0389 897 989</a>
  </footer>

<script>
  // ====== C√ÅC BI·∫æN CHUNG ======
  const API_BASE = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1")
    ? "http://127.0.0.1:5000"
    : "https://xuka.com.vn";
  const MASTER_PASSPHRASE = "thay-bang-chuoi-bi-mat";
  const te = new TextEncoder();
  const td = new TextDecoder();

  function b64ToU8(b64) {
    return new Uint8Array([...atob(b64)].map(c => c.charCodeAt(0)));
  }

  async function deriveAesKey(passphrase, salt) {
    const keyMaterial = await crypto.subtle.importKey(
      "raw", te.encode(passphrase), { name: "PBKDF2" }, false, ["deriveKey"]
    );
    return crypto.subtle.deriveKey(
      { name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256" },
      keyMaterial,
      { name: "AES-GCM", length: 256 },
      false,
      ["encrypt", "decrypt"]
    );
  }

  async function decryptWithPassphrase(encryptedData, passphrase) {
    const [version, saltB64, ivB64, dataB64] = encryptedData.split(".");
    if (version !== "v1" || !saltB64 || !ivB64 || !dataB64) {
      throw new Error("ƒê·ªãnh d·∫°ng m√£ QR kh√¥ng h·ª£p l·ªá");
    }
    const salt = b64ToU8(saltB64);
    const iv = b64ToU8(ivB64);
    const data = b64ToU8(dataB64);
    const key = await deriveAesKey(passphrase, salt);
    const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, data);
    return JSON.parse(td.decode(decrypted));
  }

  // ====== LI√äN K·∫æT C√ÅC PH·∫¶N T·ª¨ HTML ======
  const qrCard = document.getElementById("qr-login");
  const readerElem = document.getElementById("reader");
  const qrFileInput = document.getElementById("qr-file");
  const qrErrorElem = document.getElementById("qr-error");
  const flipBtn = document.getElementById("flip-camera");
  const uploadBtn = document.getElementById("upload-qr");
  const stopBtn = document.getElementById("stop-camera");

  let html5QrCode = null;
  let devices = [];
  let camIndex = 0;

  async function checkCameraPermission() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      stream.getTracks().forEach(track => track.stop());
      return true;
    } catch (err) {
      console.error("Quy·ªÅn camera b·ªã t·ª´ ch·ªëi:", err);
      qrErrorElem.textContent = "Vui l√≤ng c·∫•p quy·ªÅn truy c·∫≠p camera trong c√†i ƒë·∫∑t tr√¨nh duy·ªát!";
      qrErrorElem.classList.remove("hidden");
      return false;
    }
  }

  async function startQrScanner() {
    if (!readerElem) {
      console.error("Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ reader!");
      qrErrorElem.textContent = "L·ªói giao di·ªán: Kh√¥ng t√¨m th·∫•y khung camera!";
      qrErrorElem.classList.remove("hidden");
      return;
    }
    html5QrCode = new Html5Qrcode("reader");

    const hasPermission = await checkCameraPermission();
    if (!hasPermission) return;

    Html5Qrcode.getCameras()
      .then(list => {
        devices = list || [];
        if (devices.length === 0) {
          qrErrorElem.textContent = "Kh√¥ng t√¨m th·∫•y camera n√†o tr√™n thi·∫øt b·ªã!";
          qrErrorElem.classList.remove("hidden");
          return;
        }
        const camId = devices[camIndex].id || { facingMode: "environment" };
        return html5QrCode.start(
          camId,
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            html5QrCode.stop().then(() => verifyAndLogin(decodedText));
          },
          (error) => {
            console.warn("K·∫øt qu·∫£ qu√©t QR:", error);
          }
        );
      })
      .catch(err => {
        console.error("L·ªói truy c·∫≠p camera:", err);
        qrErrorElem.textContent = `L·ªói khi truy c·∫≠p camera: ${err.message}`;
        qrErrorElem.classList.remove("hidden");
      });
  }

  async function verifyAndLogin(qrText) {
    qrErrorElem.classList.add("hidden");
    try {
      if (qrText.startsWith("v1.")) {
        const decoded = await decryptWithPassphrase(qrText, MASTER_PASSPHRASE);
        if (!decoded.username || !decoded.password) throw new Error("D·ªØ li·ªáu gi·∫£i m√£ kh√¥ng h·ª£p l·ªá");
        qrText = `${decoded.username}:${decoded.password}`;
      }

      const res = await fetch("/api/decrypt_qr", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": (document.querySelector('meta[name="csrf-token"]')||{}).content || ""
        },
        body: JSON.stringify({ qr_value: qrText.trim() })
      });

      const data = await res.json();
      if (data.status === "success") {
        // ·∫®n c·ªôt tr√°i, c·ªôt ph·∫£i, nh√≥m n√∫t, v√† QR login
        document.getElementById('left-column').style.display = 'none';
        document.getElementById('right-column').style.display = 'none';
        document.getElementById('button-group').style.display = 'none';
        document.getElementById('qr-login').style.display = 'none';
        // Hi·ªÉn th·ªã form ƒëƒÉng nh·∫≠p
        document.getElementById('account-login').classList.remove('hidden');
        document.getElementById('account-login').scrollIntoView({ behavior: "smooth" });
      } else {
        qrErrorElem.textContent = data.msg || "M√£ QR kh√¥ng h·ª£p l·ªá!";
        qrErrorElem.classList.remove("hidden");
      }
    } catch (err) {
      console.error("L·ªói gi·∫£i m√£/k·∫øt n·ªëi:", err);
      qrErrorElem.textContent = err.message || "L·ªói k·∫øt n·ªëi m√°y ch·ªß!";
      qrErrorElem.classList.remove("hidden");
    }
  }

  if (flipBtn) {
    flipBtn.addEventListener("click", async () => {
      if (!devices.length || !html5QrCode) return;
      camIndex = (camIndex + 1) % devices.length;
      try {
        await html5QrCode.stop();
        await html5QrCode.start(
          devices[camIndex].id,
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            html5QrCode.stop().then(() => verifyAndLogin(decodedText));
          },
          () => {}
        );
      } catch (e) {
        console.error("Kh√¥ng ƒë·ªïi ƒë∆∞·ª£c camera:", e);
      }
    });
  }

  if (uploadBtn && qrFileInput) {
    uploadBtn.addEventListener("click", () => qrFileInput.click());
    qrFileInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const qrCode = new Html5Qrcode("reader");
      try {
        const decoded = await qrCode.scanFile(file, true);
        if (html5QrCode) { try { await html5QrCode.stop(); } catch(_){} }
        verifyAndLogin(decoded);
      } catch (err) {
        console.error(err);
        qrErrorElem.textContent = "Kh√¥ng th·ªÉ ƒë·ªçc m√£ QR t·ª´ ·∫£nh!";
        qrErrorElem.classList.remove("hidden");
      }
    });
  }

  if (stopBtn) {
    stopBtn.addEventListener("click", async () => {
      if (html5QrCode) {
        try {
          await html5QrCode.stop();
          qrErrorElem.textContent = "ƒê√£ d·ª´ng camera.";
          qrErrorElem.classList.remove("hidden");
        } catch (e) {
          console.error("L·ªói d·ª´ng camera:", e);
          qrErrorElem.textContent = "L·ªói khi d·ª´ng camera!";
          qrErrorElem.classList.remove("hidden");
        }
      }
    });
  }

  // Kh·ªüi ƒë·ªông qu√©t
  startQrScanner();

  function checkLogin() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    if (username && password) {
      // ·∫®n form ƒëƒÉng nh·∫≠p v√† hi·ªÉn th·ªã form th√¥ng tin th√≠ sinh
      document.getElementById('account-login').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
      document.getElementById('login-form').scrollIntoView({ behavior: "smooth" });
    } else {
      document.getElementById('login-error').textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√†i kho·∫£n v√† m·∫≠t kh·∫©u!';
      document.getElementById('login-error').classList.remove('hidden');
    }
  }

  // X·ª≠ l√Ω submit form ƒëƒÉng nh·∫≠p
  document.getElementById('account-login-form').addEventListener('submit', function(e) {
    e.preventDefault();
    checkLogin();
  });

  function updateCountdown() {
    const m = Math.floor(time / 60).toString().padStart(2, '0');
    const s = (time % 60).toString().padStart(2, '0');
    document.getElementById("countdown").innerText = `Th·ªùi gian: ${m}:${s}`;
    if (time <= 0) {
      clearInterval(timer);
      let unanswered = 0;
      questionData.forEach((q, i) => {
        const selected = getAnswerValue(i);
        if (!selected) unanswered++;
      });
      if (unanswered > 0) {
        if (confirm(`Th·ªùi gian ƒë√£ h·∫øt! B·∫°n c√≤n ${unanswered} c√¢u ch∆∞a tr·∫£ l·ªùi. B·∫°n c√≥ mu·ªën n·ªôp b√†i kh√¥ng?`)) {
          submitExam();
        } else {
          alert("Vui l√≤ng ho√†n th√†nh c√°c c√¢u h·ªèi c√≤n l·∫°i!");
          time = 300; // Gia h·∫°n th√™m 5 ph√∫t
          timer = setInterval(updateCountdown, 1000);
        }
      } else {
        submitExam();
      }
    }
    time--;
    localStorage.setItem("savedTime", time);
  }

  function processExamContent(content) {
  let s = String(content || "");

	  // ===== B0. Chu·∫©n h√≥a k√Ω t·ª± ƒë·∫∑c bi·ªát =====
	  s = s.replace(/‚àí/g, "-");           // minus unicode -> '-'
	  s = s.replace(/œÄ/g, "\\pi");         // œÄ -> \pi

	  // ===== B1. G·ªôp c√°c d√≤ng b·ªã t√°ch sai =====
	  s = s.replace(/(\d+)\s*\n\s*(\+|\-|\)|\*|\/|\^)/g, "$1 $2");
	  s = s.replace(/(\^)\s*\n\s*(\d+)/g, "$1$2");
	  s = s.replace(/([a-zA-Z])\s*\n\s*([a-zA-Z])/g, "$1 $2");
	  s = s.replace(/\n+/g, " ");

	  // ===== B2. Chu·∫©n h√≥a kho·∫£ng tr·∫Øng c∆° b·∫£n =====
	  s = s.replace(/C√¢u\s*(\d+)\s*\.(?!\s)/gi, "C√¢u $1. ");
	  s = s.replace(/([.,;:!?])([^\s])/g, "$1 $2");
	  s = s.replace(/([a-zA-Z])(\d)/g, "$1 $2");
	  s = s.replace(/(\d)([a-zA-Z])/g, "$1 $2");

	  // ===== B2.1. Th√™m kho·∫£ng tr·∫Øng quanh to√°n t·ª≠ & k√Ω hi·ªáu to√°n =====
	  s = s.replace(/\s*([+\-*/=])\s*/g, " $1 ");     // + - * / =
	  s = s.replace(/([^\s])‚à´/g, "$1 ‚à´");             // tr∆∞·ªõc ‚à´
	  s = s.replace(/‚à´([^\s])/g, "‚à´ $1");             // sau ‚à´
	  s = s.replace(/([^\s])dx\b/gi, "$1 dx");        // tr∆∞·ªõc dx
	  // sinx -> sin x, log2x -> log2 x, ...
	  s = s.replace(/\b(sin|cos|tan|cot|sec|csc|arctan|arcsin|arccos|ln|log)\s*([A-Za-z0-9\\pi])/gi, "$1 $2");

	  // M·ªôt s·ªë c·ª•m TV b·ªã d√≠nh
	  s = s.replace(/\bGi·∫£ih·ªáb·∫•tph∆∞∆°ngtr√¨nh\b/gi, "Gi·∫£i h·ªá b·∫•t ph∆∞∆°ng tr√¨nh");
	  s = s.replace(/\bGi·∫£ib·∫•tph∆∞∆°ngtr√¨nh\b/gi, "Gi·∫£i b·∫•t ph∆∞∆°ng tr√¨nh");

	  // G·ªçn kho·∫£ng tr·∫Øng th·ª´a
	  s = s.replace(/\s{2,}/g, " ").trim();

	  // ===== B3. Chu·∫©n h√≥a to√°n c∆° b·∫£n =====
	  s = s.replace(/\blog(\d+)\(([^)]+)\)/gi, (_, base, arg) => `\\log_{${base}}(${arg.trim()})`);
	  s = s.replace(/\blog\(([^)]+)\)/gi, (_, arg) => `\\log(${arg.trim()})`);
	  s = s.replace(/ln\(([^)]+)\)/gi, (_, arg) => `\\ln(${arg.trim()})`);
	  s = s.replace(/frac\(([^,]+),([^)]+)\)/gi, (_, a, b) => `\\frac{${a.trim()}}{${b.trim()}}`);
	  s = s.replace(/\b([A-Za-z0-9]+)\/([A-Za-z0-9]+)\b/g, (_, a, b) => `\\frac{${a}}{${b}}`);
	  s = s.replace(/sqrt\[(\d+)\]\(([^)]+)\)/gi, (_, n, val) => `\\sqrt[${n}]{${val.trim()}}`);
	  s = s.replace(/sqrt\(([^)]+)\)/gi, (_, val) => `\\sqrt{${val.trim()}}`);
	  s = s.replace(/([A-Za-z])_(\d+)/g, (_, base, sub) => `${base}_{${sub}}`);
	  s = s.replace(/([A-Za-z0-9])\^(\d+)/g, (_, base, sup) => `${base}^{${sup}}`);

	  // ===== B4. To√°n n√¢ng cao =====
	  s = s.replace(/int_([^_]+)(?:_([^_]+))?([^]*?)(?=\s|$)/gi, (_, from, to, body) =>
		`\\int${from ? `_{${from}}` : ""}${to ? `^{${to}}` : ""}${body.trim()}`
	  );
	  s = s.replace(/sum_([^_]+)(?:_([^_]+))?([^]*?)(?=\s|$)/gi, (_, from, to, body) =>
		`\\sum${from ? `_{${from}}` : ""}${to ? `^{${to}}` : ""}${body.trim()}`
	  );
	  s = s.replace(/lim_([^_]+)([^]*?)(?=\s|$)/gi, (_, limit, body) => `\\lim_{${limit}}${body.trim()}`);
	  s = s.replace(/d\/dx\(([^)]+)\)/gi, (_, expr) => `\\frac{d}{dx}(${expr.trim()})`);
	  s = s.replace(/vec\{(\w+)\}/gi, (_, v) => `\\vec{${v}}`);
	  s = s.replace(/\|vec\{(\w+)\}\|/gi, (_, v) => `|\\vec{${v}}|`);

	  // ===== B5. V·∫≠t l√Ω/h√≥a h·ªçc =====
	  s = s.replace(/Delta/g, "\\Delta");
	  s = s.replace(/nabla/g, "\\nabla");
	  s = s.replace(/(\w+)_(\w+)/g, (_, base, sub) => `${base}_{${sub}}`);
	  s = s.replace(/(\w+)\^(\w+)/g, (_, base, sup) => `${base}^{${sup}}`);
	  s = s.replace(/H_2O/g, "\\ce{H2O}");
	  s = s.replace(/CO_2/g, "\\ce{CO2}");
	  s = s.replace(/([A-Z][a-z]?)_(\d+)/g, (_, elem, num) => `\\ce{${elem}${num}}`);
	  
	  
	 

    // ===== B0. Chu·∫©n h√≥a k√Ω t·ª± ƒë·∫∑c bi·ªát =====
    s = s.replace(/‚àí/g, "-").replace(/œÄ/g, "\\pi");

    // ===== B1. G·ªôp d√≤ng b·ªã t√°ch sai =====
    s = s.replace(/(\d+)\s*\n\s*([+\-*/^])/g, "$1 $2");
    s = s.replace(/([+\-*/^])\s*\n\s*(\d+)/g, "$1 $2");

    // ===== B2. e(2x) ho·∫∑c e^(2 x) -> e^{2x} =====
    s = s.replace(/\be\s*\(\s*([^)]+?)\s*\)/g, (m, p1) => `e^{${p1.replace(/\s+/g, "")}}`);
    s = s.replace(/\be\^\s*\(\s*([^)]+?)\s*\)/g, (m, p1) => `e^{${p1.replace(/\s+/g, "")}}`);

    // ===== B3. ƒê·ªïi x2 -> x^{2}, k·ªÉ c·∫£ c√≥ kho·∫£ng tr·∫Øng =====
    s = s.replace(/([a-zA-Z])\s*(\d+)/g, "$1^{$2}");


    // ===== B4. 1/x -> \frac{1}{x} =====
    s = s.replace(/(?<!\\frac\{)1\s*\/\s*([a-zA-Z0-9\\pi\+\-\*\/]+)/g, "\\frac{1}{$1}");

    // ===== B5. D·∫°ng t√≠ch ph√¢n ti·∫øng Vi·ªát =====
    s = s.replace(
        /‚à´\s*t·ª´\s*([^\s]+)\s*ƒë·∫øn\s*([^\s]+)\s*c·ªßa\s*\(?\s*([^)]+?)\s*\)?\s*dx/gi,
        (_, a, b, expr) => `\\int_{${a}}^{${b}} ${expr.trim()} \\, dx`
    );

    // ‚à´t·ª´0ƒë·∫ønœÄ/2c·ªßa(sinx)dx
	s = s.replace(
	  /‚à´\s*t·ª´\s*([^\s]+?)\s*ƒë·∫øn\s*([^\s]+?)\s*c·ªßa\s*\(?\s*([^)]+?)\s*\)?\s*dx/gi,
	  (_, a, b, expr) => {
		a = a.replace(/œÄ/g, "\\pi");
		b = b.replace(/œÄ/g, "\\pi");
		return `\\int_{${a}}^{${b}} ${expr.trim()} \\, dx`;
	  }
	);


    // ===== B7. ‚à´ expr dx =====
    s = s.replace(/‚à´\s*([^\n\r]+?)\s*dx\b/gi, (_, expr) => `\\int ${expr.trim()} \\, dx`);

    // ===== B8. sin/cos/tan... =====
    s = s.replace(/\b(sin|cos|tan|cot|sec|csc|arctan|arcsin|arccos)\s*([A-Za-z0-9\\pi])/gi, "$1 $2");

    // ===== B9. B·ªçc c√¥ng th·ª©c to√°n =====
    s = s.replace(/(\\frac\{[^}]+\}\{[^}]+\}|\\int[^;\n]+|e\^\{[^}]+\}|[a-zA-Z]+\^\{[^}]+\}|\\pi|\\log_[^; \n]+|\\sqrt\{[^}]+\})/g, "\\($1\\)");

   

     
  
  
  
  // ===== B7. Ch·ªâ b·ªçc T·ª™NG bi·ªÉu th·ª©c, kh√¥ng b·ªçc c·∫£ chu·ªói =====
  function isInsideMath(str, offset) {
    const upto = str.slice(0, offset);
    const lastOpen = upto.lastIndexOf("\\(");
    const lastClose = upto.lastIndexOf("\\)");
    return lastOpen > lastClose;
  }

  const patterns = [
    /\\int[\s\S]*?\\,\s*dx/g,               // t√≠ch ph√¢n
    /\\frac\{[^}]+\}\{[^}]+\}/g,
    /\\sqrt(?:\[[^\]]+\])?\{[^}]+\}/g,
    /\\log_\{\d+\}\([^)]*\)/g,
    /\b(?:log\d*|log|ln|sin|cos|tan|exp)\([^)]*\)/gi,
    /[A-Za-z0-9]+_\{\d+\}/g,
    /[A-Za-z0-9]\^\{\d+\}/g,
    /\\ce\{[^}]+\}/g,
    /\\Delta/g,
    /\\nabla/g
  ];

  patterns.forEach((pattern) => {
    s = s.replace(pattern, function (match, ...args) {
      const offset = args[args.length - 2];
      const str = args[args.length - 1];
      if (isInsideMath(str, offset)) return match;
      if (/^\\\(.*\\\)$/.test(match)) return match;

      const beforeChar = offset > 0 ? str[offset - 1] : "";
      const afterChar = str[offset + match.length] || "";
      const needPreSpace = beforeChar && !/[\s\(\[{,;:!?\-]/.test(beforeChar);
      const needPostSpace = afterChar && !/[\s\)\]\},;:!?.]/.test(afterChar);
      const pre = needPreSpace ? " " : "";
      const post = needPostSpace ? " " : "";
      return pre + `\\(${match}\\)` + post;
    });
  });

  // ===== B8. G·ªçn kho·∫£ng tr·∫Øng cu·ªëi =====
  s = s.replace(/\s{2,}/g, " ").trim();
  return s;
}




  function processAllQuestions(questions) {
    return questions.map(q => {
      q.noi_dung = processExamContent(q.noi_dung);
      if (q.lua_chon && typeof q.lua_chon === 'object') {
        for (let key in q.lua_chon) {
          if (q.lua_chon.hasOwnProperty(key)) {
            q.lua_chon[key] = processExamContent(q.lua_chon[key]);
          }
        }
      }
      q.dap_an_dung = q.dap_an_dung ? q.dap_an_dung : "";
      q.goi_y_dap_an = q.goi_y_dap_an ? processExamContent(q.goi_y_dap_an) : "";
      return q;
    });
  }

  function getAnswerValue(index) {
    const q = questionData[index];
    if (q.kieu_cau_hoi === "tu_luan") {
      const textarea = document.getElementById(`q${index}`);
      return textarea ? textarea.value.trim() : "";
    } else {
      const radios = document.getElementsByName(`q${index}`);
      for (const radio of radios) {
        if (radio.checked) {
          return radio.value;
        }
      }
      return "";
    }
  }

  function renderQuestions(questions) {
    const container = document.getElementById("questions");
    container.innerHTML = "";
    
    const unansweredLabel = document.createElement("p");
    unansweredLabel.id = "unanswered-count";
    unansweredLabel.classList.add("text-red-600", "font-bold", "mb-4");
    container.appendChild(unansweredLabel);

    questions.forEach((q, i) => {
      const div = document.createElement('div');
      div.classList.add("mb-6", "p-4", "bg-gray-50", "rounded-lg");
      div.innerHTML = `
        <label class="block font-semibold mb-2 text-lg">
          C√¢u ${i + 1}: ${q.noi_dung}
        </label>
      `;
      if (q.kieu_cau_hoi === "tu_luan") {
        div.innerHTML += `
          <textarea id="q${i}" rows="4" 
            class="border p-2 w-full rounded-md" 
            placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..."></textarea>
        `;
      } else if (q.lua_chon) {
        const optionsHtml = Object.entries(q.lua_chon).map(([k, v]) => {
          return `
            <div class="flex items-start space-x-2 min-w-max">
              <input type="radio" name="q${i}" id="q${i}_${k}" value="${k}" class="mt-1">
              <label for="q${i}_${k}" class="overflow-x-auto block" style="max-width: calc(100% - 30px);">
                ${k}. ${v}
              </label>
            </div>
          `;
        }).join("");
        div.innerHTML += `
          <div class="border rounded-md p-2 max-h-40 overflow-y-auto space-y-2">
            ${optionsHtml}
          </div>
        `;
      }
      container.appendChild(div);
    });

    function updateUnansweredCount() {
      let unanswered = 0;
      questions.forEach((q, i) => {
        const selected = getAnswerValue(i);
        if (!selected) unanswered++;
      });
      unansweredLabel.innerText = `C√¢u ch∆∞a tr·∫£ l·ªùi: ${unanswered}`;
    }

    questions.forEach((q, i) => {
      if (q.kieu_cau_hoi === "tu_luan") {
        const textarea = document.getElementById(`q${i}`);
        if (textarea) {
          textarea.addEventListener("input", () => {
            const current = JSON.parse(localStorage.getItem("savedAnswers") || "{}");
            current[`q${i}`] = textarea.value;
            localStorage.setItem("savedAnswers", JSON.stringify(current));
            updateUnansweredCount();
          });
        }
      } else {
        const radios = document.getElementsByName(`q${i}`);
        radios.forEach(radio => {
          radio.addEventListener("change", () => {
            const current = JSON.parse(localStorage.getItem("savedAnswers") || "{}");
            current[`q${i}`] = radio.value;
            localStorage.setItem("savedAnswers", JSON.stringify(current));
            updateUnansweredCount();
          });
        });
      }
    });

    updateUnansweredCount();
    if (typeof MathJax !== 'undefined') {
      MathJax.Hub.Queue(["Typeset", MathJax.Hub, container]);
    }
  }

  function startExam() {
    const name = document.getElementById('hoten').value.trim();
    const sbd = document.getElementById('sbd').value.trim();
    const dob = document.getElementById("ngaysinh").value;
    const made = document.getElementById('made').value;

    if (!name || !sbd || !dob || !made) {
      return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß H·ªç t√™n, SBD, Ng√†y sinh v√† M√£ ƒë·ªÅ!");
    }

    document.getElementById("login-form").classList.add("hidden");
    document.getElementById("exam-container").classList.remove("hidden");

    const savedTime = localStorage.getItem("savedTime");
    time = savedTime ? parseInt(savedTime) : 3600;
    timer = setInterval(updateCountdown, 1000);

    const jsonFile = `/questions/questions${made}.json`;
    fetch(jsonFile, {
      headers: { 'Accept': 'application/json' }
    })
      .then(res => {
        if (!res.ok) {
          throw new Error(`Kh√¥ng th·ªÉ t·∫£i file c√¢u h·ªèi: ${res.status} ${res.statusText} (File: ${jsonFile})`);
        }
        return res.json();
      })
      .then(data => {
        if (!Array.isArray(data)) {
          throw new Error("D·ªØ li·ªáu c√¢u h·ªèi kh√¥ng ph·∫£i l√† m·∫£ng");
        }
        questionData = processAllQuestions(data);
        renderQuestions(questionData);
        restoreAnswers();
      })
      .catch(err => {
        console.error("L·ªói chi ti·∫øt:", err);
        alert(`Kh√¥ng th·ªÉ t·∫£i file c√¢u h·ªèi: ${err.message}. Vui l√≤ng ki·ªÉm tra file ${jsonFile} v√† server Flask.`);
      });
  }

  function restoreAnswers() {
    const saved = JSON.parse(localStorage.getItem("savedAnswers") || "{}");
    for (const [key, value] of Object.entries(saved)) {
      const index = parseInt(key.replace('q', ''));
      const q = questionData[index];
      if (q.kieu_cau_hoi === "tu_luan") {
        const textarea = document.getElementById(key);
        if (textarea) {
          textarea.value = value;
        }
      } else {
        const radio = document.getElementById(`${key}_${value}`);
        if (radio) {
          radio.checked = true;
        }
      }
    }
  }

  function clearTempStorage() {
    localStorage.removeItem("savedAnswers");
    localStorage.removeItem("hoten");
    localStorage.removeItem("made");
    localStorage.removeItem("savedTime");
  }

  function submitExam() {
    let unanswered = 0;
    questionData.forEach((q, i) => {
      const selected = getAnswerValue(i);
      if (!selected) unanswered++;
    });

    if (unanswered > 0) {
      if (!confirm(`B·∫°n c√≤n ${unanswered} c√¢u ch∆∞a tr·∫£ l·ªùi. B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i kh√¥ng?`)) {
        return;
      }
    }

    clearInterval(timer);
    const name = document.getElementById('hoten').value.trim();
    const made = document.getElementById('made').value;
    const sbd = document.getElementById('sbd').value.trim();
    const dob = document.getElementById("ngaysinh").value;

    const answers = [];
    let score = 0;

    questionData.forEach((q, i) => {
      const selected = getAnswerValue(i);
      const correctKey = q.dap_an_dung ? q.dap_an_dung.trim() : "";
      const kieu = q.kieu_cau_hoi ? q.kieu_cau_hoi.toLowerCase() : "trac_nghiem";

      let selectedContent = "";
      let correctContent = "";

      if (kieu === "trac_nghiem") {
        selectedContent = selected && q.lua_chon ? q.lua_chon[selected] : "(ch∆∞a ch·ªçn)";
        correctContent = correctKey && q.lua_chon ? q.lua_chon[correctKey] : "";
      } else {
        selectedContent = selected || "(ch∆∞a tr·∫£ l·ªùi)";
        correctContent = "";
      }

      const isCorrect =
        kieu === "trac_nghiem" &&
        selected.toUpperCase() === correctKey.toUpperCase();

      if (isCorrect) {
        score++;
      }

      answers.push({
        cau: i + 1,
        noi_dung: q.noi_dung,
        da_chon: processExamContent(selectedContent),
        dap_an_dung: processExamContent(correctContent),
        dung: isCorrect,
        kieu: kieu,
        goi_y_dap_an: q.goi_y_dap_an || ""
      });
    });

    const finalScore = (score / questionData.length * 10).toFixed(2);

    clearTempStorage();
    const now = new Date();
    const formattedDate = now.toLocaleString("vi-VN", {
      hour12: false,
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      day: "2-digit",
      month: "2-digit",
      year: "numeric"
    });

    let fileContent = `<div>K·∫æT QU·∫¢ B√ÄI THI</div>`;
    fileContent += `<div>H·ªç t√™n: ${name}</div>`;
    fileContent += `<div>SBD: ${sbd}</div>`;
    fileContent += `<div>Ng√†y sinh: ${dob}</div>`;
    fileContent += `<div>M√£ ƒë·ªÅ: ${made}</div>`;
    fileContent += `<div>ƒêi·ªÉm: ${finalScore}/10</div>`;
    fileContent += `<div>N·ªôp l√∫c: ${formattedDate}</div><br>`;

    answers.forEach(ans => {
      fileContent += `<div style="margin-bottom: 1rem;">C√¢u ${ans.cau}: <span>${ans.noi_dung}</span></div>`;
      fileContent += `<div>B·∫°n ch·ªçn: <span>${ans.da_chon}</span>`;
      if (ans.kieu === "trac_nghiem") {
        fileContent += ` ${ans.dung ? "- ƒê√öNG" : "- SAI"}</div>`;
        if (ans.dap_an_dung) {
          fileContent += `<div>ƒê√°p √°n ƒë√∫ng: <span>${ans.dap_an_dung}</span></div>`;
        }
      } else {
        fileContent += `</div>`;
        if (ans.goi_y_dap_an) {
          fileContent += `<div>G·ª£i √Ω ƒë√°p √°n: <span>${ans.goi_y_dap_an}</span></div>`;
        }
      }
      fileContent += `<br>`;
    });

    const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' 
    xmlns:w='urn:schemas-microsoft-com:office:word' 
    xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'>
    <title>K·∫øt qu·∫£</title></head><body>`;
    const footer = "</body></html>";
    const wordContent = header + fileContent + footer;
    const blob = new Blob(['\ufeff', wordContent], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const fileName = `KQ_${name.replace(/\s+/g, "_")}_${made}.doc`;

    const resultDiv = document.getElementById("result-container");
    resultDiv.classList.remove("hidden");
    resultDiv.innerHTML = `
      <h1 class="text-2xl font-bold text-green-600 mb-4">‚úÖ K·∫æT QU·∫¢ B√ÄI THI !</h1>
      <p class="text-sm text-gray-500 mb-4">üïí N·ªôp l√∫c: ${formattedDate}</p>
      <div class="result-scrollable">${fileContent}</div>
      <div class="flex gap-4 mt-4">
        <a href="${url}" download="${fileName}" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
          ‚¨áÔ∏è T·∫£i k·∫øt qu·∫£ .Doc
        </a>
        <button onclick="downloadPDF()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
          ‚¨áÔ∏è T·∫£i k·∫øt qu·∫£ .PDF
        </button>
      </div>
    `;
    document.getElementById("exam-container").classList.add("hidden");

    if (typeof MathJax !== 'undefined') {
      MathJax.Hub.Queue(["Typeset", MathJax.Hub, resultDiv]);
    }

    fetch(`${API_BASE}/save_result`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        hoten: name,
        sbd: sbd,
        ngaysinh: dob,
        made: made,
        diem: finalScore,
        answers: answers
      })
    })
      .then(res => res.json())
      .then(data => {
        console.log("K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o backend:", data);
      })
      .catch(err => {
        console.error("L·ªói khi l∆∞u k·∫øt qu·∫£ v√†o backend:", err);
      });
  }

  function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const resultDiv = document.getElementById("result-container").innerText;
    doc.text(resultDiv, 10, 10);
    doc.save(`KQ_${document.getElementById('hoten').value.replace(/\s+/g, "_")}_${document.getElementById('made').value}.pdf`);
  }

  document.addEventListener("DOMContentLoaded", function() {
    const select = document.getElementById("made");
    if (!select) {
      console.error("Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ <select> v·ªõi ID 'made'");
      return;
    }

    fetch("/get_exam_codes", {
      method: "GET",
      headers: {
        "Accept": "application/json",
        "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').content || ""
      }
    })
      .then(res => {
        if (!res.ok) {
          throw new Error(`L·ªói HTTP: ${res.status} ${res.statusText}`);
        }
        return res.json();
      })
      .then(data => {
        console.log("D·ªØ li·ªáu m√£ ƒë·ªÅ nh·∫≠n ƒë∆∞·ª£c:", data);
        const codes = Array.isArray(data) ? data : (data.codes || []);
        if (!codes.length) {
          console.warn("Kh√¥ng c√≥ m√£ ƒë·ªÅ n√†o t·ª´ server");
          select.innerHTML = '<option value="">-- Kh√¥ng c√≥ m√£ ƒë·ªÅ --</option>';
          return;
        }
        select.innerHTML = '<option value="">-- Ch·ªçn m√£ ƒë·ªÅ --</option>';
        codes.forEach(code => {
          const opt = document.createElement("option");
          opt.value = code;
          opt.textContent = code;
          select.appendChild(opt);
        });
      })
      .catch(err => {
        console.error("L·ªói khi t·∫£i m√£ ƒë·ªÅ:", err);
        const errorMessage = document.createElement("p");
        errorMessage.className = "text-red-600 mt-2 font-semibold";
        errorMessage.textContent = "Kh√¥ng th·ªÉ t·∫£i danh s√°ch m√£ ƒë·ªÅ. Vui l√≤ng th·ª≠ l·∫°i!";
        select.parentElement.appendChild(errorMessage);
      });
  });
</script>
</body>
</html>
